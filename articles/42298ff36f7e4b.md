---
title: "Node.jsã§ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ç’°å¢ƒå¤‰æ•°ã‚’ç®¡ç†ã™ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹"
emoji: "ğŸ›¡ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nodejs", "typescript"]
published: false
---

## ã¯ã˜ã‚ã«
Node.jsã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹ä¸­ã§ã€ç’°å¢ƒå¤‰æ•°ã®ç®¡ç†ã«ã¯å¤šãã®èª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚ä¸»ã«Cloud Runã‚’ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡Œã«ç›´é¢ã—ã¾ã—ãŸã€‚

### ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®èª²é¡Œ
- å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’ç®¡ç†ç”»é¢ã§å¤±å¿µã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

ã“ã‚Œã‚‰ã®å•é¡Œã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã‚’ç®¡ç†ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã—ãŸãŒã€æ–°ãŸãªèª²é¡ŒãŒæµ®ä¸Šã—ã¾ã—ãŸã€‚

- ä¸è¦ãªç’°å¢ƒã§ã®ç’°å¢ƒå¤‰æ•°è¨­å®šã®è¦æ±‚
- ç’°å¢ƒã¨ç’°å¢ƒå¤‰æ•°ã®è¤‡é›‘ãªé–¢ä¿‚ç®¡ç†ã«ã‚ˆã‚‹ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼
- çµæœã¨ã—ã¦ã€ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ãªç’°å¢ƒã§ã®è¨­å®šæ¼ã‚Œ

**å››è‹¦å…«è‹¦ä¸ƒè»¢å…«å€’**ã®æœ«ã«ã€ã‚ˆã†ã‚„ãæœ€çµ‚çš„ãªè§£æ±ºç­–ã‚’è¦‹å‡ºã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä»Šå›ã¯ã€ECã‚µã‚¤ãƒˆã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’ä¾‹ã«èª¬æ˜ã—ã¾ã™ã€‚

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èƒŒæ™¯
ç§ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯Node.jsã‚’ä½¿ç”¨ã—ã€APIã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒƒãƒã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¯å…±æœ‰ã—ã¦ãŠã‚Šã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ï¼š
- APIã‚µãƒ¼ãƒãƒ¼: `main.ts`
- ãƒãƒƒãƒ: `batch.ts`ï¼ˆè¤‡æ•°ã®ã‚·ãƒŠãƒªã‚ªãŒå­˜åœ¨ï¼‰

### ç’°å¢ƒå¤‰æ•°ã®è¤‡é›‘ã•
ç’°å¢ƒå¤‰æ•°ã®å¿…è¦æ€§ã¯ã€ä»¥ä¸‹ã®3ã¤ã®æ¬¡å…ƒã§æ±ºå®šã•ã‚Œã¾ã™ï¼š

1. å‹•ä½œç’°å¢ƒï¼ˆæœ¬ç•ªã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã€é–‹ç™ºï¼‰
2. å‹•ä½œãƒ¢ãƒ¼ãƒ‰ï¼ˆAPIã‚µãƒ¼ãƒãƒ¼ã€éŠ€è¡ŒæŒ¯è¾¼å…¥é‡‘ç¢ºèªãƒãƒƒãƒã€åœ¨åº«è£œå……ç™ºæ³¨ãƒãƒƒãƒï¼‰
3. ç’°å¢ƒå¤‰æ•°ã®ç¨®é¡ï¼ˆéŠ€è¡ŒAPIã‚­ãƒ¼ã€DBæ¥ç¶šæƒ…å ±ã€ãƒ¡ãƒ¼ãƒ«é–¢é€£è¨­å®šãªã©ï¼‰

ã“ã®è¤‡é›‘ãªçµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€èªçŸ¥ã‚³ã‚¹ãƒˆãŒéå¸¸ã«é«˜ãã€ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã‚„ã™ã„çŠ¶æ³ã§ã—ãŸã€‚

### æœ€çµ‚çš„ã«å®Ÿç¾ã—ãŸã„è¦ä»¶
- å„ç’°å¢ƒã§å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚¨ãƒ©ãƒ¼
- ä¸è¦ãªç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã§ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ãªã„
- ç’°å¢ƒå¤‰æ•°ã®é™çš„å‹ä»˜ã‘
- å‹ã®ä¸ä¸€è‡´ãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã‚¨ãƒ©ãƒ¼

ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®æœ€çµ‚çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å…±æœ‰ã—ã¾ã™ã€‚

## å®Œæˆå½¢
### ç’°å¢ƒå¤‰æ•°ã®å‹å®šç¾©

```ts
type NodeEnvType = 'test' | 'development' | 'production';
type AppEnvType = 'develop' | 'staging' | 'production';
type ServiceEnvType = "api-server" | "bank-detection-batch" | "inventory-refill-batch";
type BankApiKeyType = string; // éŠ€è¡Œã®APIã‚­ãƒ¼
type DbConnectionType = string; // DBæ¥ç¶šæƒ…å ±
type MailSenderAddressType = string; // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹
type AuditMailAddressType = string; // BCCã«è¨­å®šã™ã‚‹ç›£æŸ»ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
type MailSenderApiKeyType = string; // ãƒ¡ãƒ¼ãƒ«é€ä¿¡APIã‚­ãƒ¼
type StagingBasicAuthType = `${string}:${string}`; // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨BASICèªè¨¼æ–‡å­—åˆ—
```

### ç’°å¢ƒå¤‰æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

```ts
interface EnvironmentConfig {
  BANK_API_KEY: BankApiKeyType,
  DB_CONNECTION_STRING: DbConnectionType,
  MAIL_SENDER_ADDRESS: MailSenderAddressType,
  AUDIT_MAIL_ADDRESS: AuditMailAddressType,
  MAIL_SENDER_API_KEY: MailSenderApiKeyType,
  STAGING_BASIC_AUTH: StagingBasicAuthType,
}
```

### å„ã‚µãƒ¼ãƒ“ã‚¹ã¨ç’°å¢ƒã®çµ„ã¿åˆã‚ã›ã”ã¨ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©
```ts
type RequiredEnvVars = {
  [service in ServiceEnvType]: {
    [env in AppEnvType]: Array<keyof EnvironmentConfig>;
  };
};
```

### å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®å®šç¾©
```ts
const requiredEnvVars: RequiredEnvVars = {
  "api-server": {
    production: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "AUDIT_MAIL_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
    staging: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
      "STAGING_BASIC_AUTH",
    ],
    develop: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
  },
  "bank-detection-batch": {
    production: [
      "DB_CONNECTION_STRING",
      "BANK_API_KEY",
      "MAIL_SENDER_ADDRESS",
      "AUDIT_MAIL_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
    staging: [
      "DB_CONNECTION_STRING",
      "BANK_API_KEY",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
    develop: [
      "DB_CONNECTION_STRING",
      "BANK_API_KEY",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
  },
  "inventory-refill-batch": {
    production: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
    staging: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
    develop: [
      "DB_CONNECTION_STRING",
      "MAIL_SENDER_ADDRESS",
      "MAIL_SENDER_API_KEY",
    ],
  }
};
```

### ç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
```ts
const defaultValues: EnvironmentConfig = {
  BANK_API_KEY: "",
  DB_CONNECTION_STRING: "",
  MAIL_SENDER_ADDRESS: "",
  AUDIT_MAIL_ADDRESS: "",
  MAIL_SENDER_API_KEY: "",
  STAGING_BASIC_AUTH: ":",
};
```

### ç’°å¢ƒå¤‰æ•°ã‚’å–ã‚Šå‡ºã—ã¦å‹ä»˜ã‘ã‚’ã—ã¦è¿”ã™å‡¦ç†
```ts
/**
 * test, development, production
 */
export const NODE_ENV: NodeEnvType = (function () {
  const env = process.env.NODE_ENV;
  if (!env) {
    throw new Error('NODE_ENV is not defined');
  }
  if (!['test', 'development', 'production'].includes(env)) {
    throw new Error('NODE_ENV is not test, development, production');
  }
  return env as NodeEnvType;
})();

/**
 * develop, staging, production
 */
export const APP_ENV: AppEnvType = (function () {
  const env = process.env.APP_ENV;
  if (!env) {
    throw new Error('APP_ENV is not defined');
  }
  if (!['develop', 'staging', 'production'].includes(env)) {
    throw new Error('APP_ENV is not develop, staging, production');
  }
  return env as AppEnvType;
})();

/**
 * api-server, bank-detection-batch, inventory-refill-batch
 */
export const SERVICE_ENV: ServiceEnvType = (function () {
  const env = process.env.SERVICE_ENV;
  if (!env) {
    throw new Error('SERVICE_ENV is not defined');
  }
  if (!['api-server', 'bank-detection-batch', 'inventory-refill-batch'].includes(env)) {
    throw new Error('SERVICE_ENV is not api-server, bank-detection-batch, inventory-refill-batch');
  }
  return env as ServiceEnvType;
})()

/**
 * éŠ€è¡Œã®APIã‚­ãƒ¼
 */
export const BANK_API_KEY: BankApiKeyType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("BANK_API_KEY")) {
    return defaultValues.BANK_API_KEY
  }

  const env = process.env.BANK_API_KEY;
  if (!env) {
    throw new Error('BANK_API_KEY is not defined');
  }
  return env as BankApiKeyType;
})()

/**
 * DBæ¥ç¶šæƒ…å ±
 */
export const DB_CONNECTION_STRING: DbConnectionType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("DB_CONNECTION_STRING")) {
    return defaultValues.DB_CONNECTION_STRING
  }

  const env = process.env.DB_CONNECTION_STRING;
  if (!env) {
    throw new Error('DB_CONNECTION_STRING is not defined');
  }
  return env as DbConnectionType;
})()

/**
 * ãƒ¡ãƒ¼ãƒ«é€ä¿¡å…ƒã‚¢ãƒ‰ãƒ¬ã‚¹
 */
export const MAIL_SENDER_ADDRESS: MailSenderAddressType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("MAIL_SENDER_ADDRESS")) {
    return defaultValues.MAIL_SENDER_ADDRESS
  }

  const env = process.env.MAIL_SENDER_ADDRESS;
  if (!env) {
    throw new Error('MAIL_SENDER_ADDRESS is not defined');
  }
  return env as MailSenderAddressType;
})()

/**
 * BCCã«è¨­å®šã™ã‚‹ç›£æŸ»ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 */
export const AUDIT_MAIL_ADDRESS: AuditMailAddressType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("AUDIT_MAIL_ADDRESS")) {
    return defaultValues.AUDIT_MAIL_ADDRESS
  }

  const env = process.env.AUDIT_MAIL_ADDRESS;
  if (!env) {
    throw new Error('AUDIT_MAIL_ADDRESS is not defined');
  }
  return env as AuditMailAddressType;
})()

/**
 * ãƒ¡ãƒ¼ãƒ«é€ä¿¡APIã‚­ãƒ¼
 */
export const MAIL_SENDER_API_KEY: MailSenderApiKeyType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("MAIL_SENDER_API_KEY")) {
    return defaultValues.MAIL_SENDER_API_KEY
  }

  const env = process.env.MAIL_SENDER_API_KEY;
  if (!env) {
    throw new Error('MAIL_SENDER_API_KEY is not defined');
  }

  return env as MailSenderApiKeyType;
})()

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨BASICèªè¨¼æ–‡å­—åˆ—
 */
export const STAGING_BASIC_AUTH: StagingBasicAuthType = (function () {
  const requiredEnvs = requiredEnvVars[SERVICE_ENV][APP_ENV]
  if (!requiredEnvs.includes("STAGING_BASIC_AUTH")) {
    return defaultValues.STAGING_BASIC_AUTH
  }

  const env = process.env.STAGING_BASIC_AUTH;
  if (!env) {
    throw new Error('STAGING_BASIC_AUTH is not defined');
  }

  return env as StagingBasicAuthType;
})()
```

## ã¾ã¨ã‚
ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã‹ã€ä¸å¿…è¦ã‹ã®å…¨ã¦ã®è¤‡é›‘æ€§ã¯ `requiredEnvVars` ã«é›†ç´„ã—ã€å–ã‚Šå‡ºã™æ™‚ã«ã¯ã»ã¼åŒã˜å‡¦ç†ã®ç¹°ã‚Šè¿”ã—ã§æ¸ˆã‚€ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

é–¢æ•°å®šç¾©ã‚’
```ts
const hoge = (function(){
  // å‡¦ç†
})()
```
ã®ã‚ˆã†ã«ã—ã¦ã€é–¢æ•°å®šç¾©ã‚’å³æ™‚å®Ÿè¡Œã—ãŸçµæœã‚’å¤‰æ•°ã«ä»£å…¥ã™ã‚‹ã“ã¨ã§ã€ã‚‚ã—ã‚ã‚‹ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ãªç’°å¢ƒã§è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã€å®Ÿè¡Œç›´å¾Œã«ã‚¨ãƒ©ãƒ¼ã§è½ã¡ã‚‹ã“ã¨ã«ãªã‚Šã€ãƒŸã‚¹ã«æ°—ã¥ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã‚ãªã„ç’°å¢ƒã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¿”ã‚‹ã®ã§ã€ä¸å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ã‚‚èµ·ã“ã‚Šã¾ã›ã‚“ã€‚

ã“ã‚Œã‚’å‘¼ã³å‡ºã™æ™‚ã«ã¯
```ts
import {BANK_API_KEY} from './env';

console.log(BANK_API_KEY);
```
ã¨ã„ã†ã‚ˆã†ã«å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚


ä»¥ä¸Šã§ã™ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
