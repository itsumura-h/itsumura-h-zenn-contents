---
title: "Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘¡ â€• Nimã®ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹"
emoji: "ðŸ‘‘"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nim"]
published: false
---

Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã«ã¤ã„ã¦ç†è§£ã—ã¦ã„ã“ã†ã€ãã—ã¦ãã®å†…å®¹ã‚’æ—¥æœ¬èªžã§ã¡ã‚ƒã‚“ã¨å…¬é–‹ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ã—ã‚ˆã†ã¨ã„ã†ã“ã¨ã§ã€æ˜”æ›¸ã„ãŸè¨˜äº‹ã‹ã‚‰ã‚·ãƒªãƒ¼ã‚ºåŒ–ã•ã›ãŸç¶šç·¨ã¨ã—ã¦ä»Šå›žã¯ä½œè€…ã®è¬›æ¼”ã®å…¨è¨³ã‚’ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://www.youtube.com/watch?v=yA32Wxl59wo

---

ã€œNimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹ã‚·ãƒªãƒ¼ã‚ºã€œ
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘  â€• Nimã®æ–°ã—ã„GCã€ARCã«ã¤ã„ã¦](https://qiita.com/dumblepy/items/be660c17556d73aa3570)

---

## ã¯ã˜ã‚ã«
"æ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çœŸä¼¼ã™ã‚‹ã“ã¨ã¯è‰¯ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã¯ãªã„" -- Niméžå…¬å¼ãƒ¢ãƒƒãƒˆãƒ¼
- "æ‚ªã„è¨­è¨ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã¯ã„ã‘ãªã„ï¼"
- "ã„ãã¤ã‚‚ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®è‰¯ã„è¨­è¨ˆã‚’çµ„ã¿åˆã‚ã›ã‚ˆã†ï¼"

ç§ã¯Andreas Rumpfã§ã€Nimã®æœ€åˆã®ç™ºæ˜Žè€…ã§ã‚ã‚Šã€ç¾åœ¨ã‚‚é–‹ç™ºãƒªãƒ¼ãƒ€ãƒ¼ã‚’å‹™ã‚ã¦ã„ã¾ã™ã€‚
Rustã¨C++ã«è§¦ç™ºã•ã‚Œã¦Nimã«å°Žå…¥ã•ã‚ŒãŸæ–°æ©Ÿèƒ½ã§ã‚ã‚‹ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã«ã¤ã„ã¦ãŠè©±ã—ã¾ã™ã€‚
ã§ã¯ã€ã¯ã˜ã‚ã¾ã—ã‚‡ã†ã€‚

Nimã®éžå…¬å¼ãªãƒ¢ãƒƒãƒˆãƒ¼ã¯ã€æ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çœŸä¼¼ã™ã‚‹ã“ã¨ã¯è‰¯ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã¯ãªã„ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã“ã‚Œã¯ã™ã§ã«æœ‰ç”¨ãªãƒ¢ãƒƒãƒˆãƒ¼ã§ã€ä½•ã‚’ã™ã¹ãã§ãªã„ã‹ã‚’æ•™ãˆã¦ãã‚Œã¦ã„ã¾ã™ã€‚
ãã†ã§ã™ã€ç§ãŸã¡ã¯æ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çœŸä¼¼ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã¾ãŸã€ä½•ã‚’ã™ã¹ãã§ãªã„ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã‚ˆã‚Šã‚‚ã€ä½•ã‚’ã™ã¹ãã‹ã‚’çŸ¥ã‚‹ã“ã¨ã®æ–¹ãŒæœ‰ç”¨ã§ã™ã€‚
ã“ã‚Œã‚’è¨€ã„æ›ãˆã‚‹ã¨ã€ã„ãã¤ã‹ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰è‰¯ã„éƒ¨åˆ†ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¹ãã ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ãã“ã§ç§ãŸã¡ã¯ã€Rustã‚„C++ã‚„SwiftãŒã©ã®ã‚ˆã†ã«ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã€ã“ã‚Œã‚‰ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆãŒNimã«ã‚‚é©ç”¨ã§ãã‚‹ã®ã‹ã©ã†ã‹ã‚’èª¿ã¹ã¾ã—ãŸã€‚
ãã®çµæžœã€ç­”ãˆã¯ã€Œã‚¤ã‚¨ã‚¹ã€ã§ã—ãŸã€‚

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
```nim
var someNumbers = @[1, 2]
someNumbers.add 3
```
ã“ã“ã®ä¾‹ã§ã¯2ã¤ã®è¦ç´ ã‚’æŒã¤é…åˆ—ãŒã‚ã‚Šã€ãã“ã«æ•°å­—ã®3ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯å¯å¤‰é•·ã®é…åˆ—ã§ã™ã€‚C++ã§ã¯vectorã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ãŒNimã§ã¯ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¨å‘¼ã³ã¾ã™ã€‚

## ãƒ¡ãƒ¢ãƒªä¸Šã§èµ·ãã¦ã„ã‚‹ã“ã¨
```
someNumbers

Length: 2     â”Œâ”€â”€> 1
Capacity: 2   â”‚    2
Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
ã“ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã¯ã€é•·ã•ã¨å®¹é‡ã€ãã—ã¦å¯å¤‰é•·ã®ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã¸ã®ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
æ•°å­—ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«ã¯ã€ã™ã§ã«å®¹é‡ãŒä¸€æ¯ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€2ã¤ã®è¦ç´ ã®å®¹é‡ã‚’æŒã¤ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ¡ãƒ¢ãƒªä¸Šã§èµ·ãã¦ã„ã‚‹ã“ã¨ï¼ˆ2ï¼‰
```
someNumbers

Length: 3     â”Œâ”€/â”€> 1
Capacity: 4   â”‚     2
Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚
              â””â”€â”€â”€â”€>1
                    2
                    3
```

3ã¤ã®æ•°å­—ã‚’æ ¼ç´ã™ã‚‹ã®ã«ååˆ†ãªå¤§ãã•ã®æ–°ã—ã„ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã—ã¦ã€å¤ã„ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ã©ã†ã«ã‹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
é€šå¸¸ã¯å†å‰²ã‚Šå½“ã¦(realloc)ã®ã‚ˆã†ã«ã€å¤ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã™ãã«è§£æ”¾ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã¯æœ€ã‚‚åŠ¹æžœçš„ãªæ–¹æ³•ã§ã™ã€‚


## æµ…ã„ã‚³ãƒ”ãƒ¼ã€ã‚³ãƒ”ãƒ¼ã€ãƒ ãƒ¼ãƒ–
```nim
var someNumbers = @[1, 2]
var other = someNumbers
someNumbers.add 3 # otherãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã£ã¦ã„ã‚‹
```

ã—ã‹ã—ã€ã“ã‚Œã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚å•é¡Œã¯ã€ä»–ã®å¤‰æ•°ãŒã“ã®å¤‰æ•°ã¸ã®å‚ç…§ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã—ãªã‘ã‚Œã°ã„ã‘ãªã„ã“ã¨ã§ã™ã€‚
2è¡Œç›®ã§ `other`ã¨ã„ã†å¤‰æ•°ãŒã‚ã‚Šã€ãã®ä¸­èº«ã¯`someNumbers`ã¨åŒã˜ã§ã‚ã‚‹ã¹ãã ã¨è¨€ã£ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ã€æµ…ã„ã‚³ãƒ”ãƒ¼ã§ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã—ã¾ã†ã¨ã€3è¡Œç›®ã®è¿½åŠ ã§ç„¡åŠ¹ã«ãªã£ãŸãƒã‚¤ãƒ³ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã«ãªã‚Šã€ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚“ã§ã—ã¾ã†ã®ã§ã€éžå¸¸ã«å±é™ºã§æ‚ªã„å®Ÿè£…ã§ã™ã€‚

## æµ…ã„ã‚³ãƒ”ãƒ¼ã€ã‚³ãƒ”ãƒ¼ã€ãƒ ãƒ¼ãƒ–ï¼ˆ2ï¼‰
```nim
var someNumbers = @[1, 2]
var other = someNumbers
someNumbers.add 3 # otherãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã£ã¦ã„ã‚‹
```

- è§£æ±ºç­–1: å…¨ãåŒã˜å†…å®¹ã®æ–°ã—ã„é…åˆ—ã‚’ä½œã‚‹ ("Deep" copy: C++98, ã“ã‚Œã¾ã§ã®Nim)
- è§£æ±ºç­–2: ãƒã‚¤ãƒ³ã‚¿ã¸ã®å‚ç…§ã‚’æŒã¤ãƒã‚¤ãƒ³ã‚¿ã‚’ä½œã‚‹ (å¤šãallocãŒç™ºç”Ÿã—ã€é…ã„)
- è§£æ±ºç­–3: ä»£å…¥ã‚’ç¦æ­¢ã™ã‚‹
- è§£æ±ºç­–4: GCã«ã‚ˆã£ã¦å¤ã„ãƒã‚¤ãƒ³ã‚¿ã‚’æŽƒé™¤ã—ã¦ã‚‚ã‚‰ã†
- è§£æ±ºç­–5: ãƒ¡ãƒ¢ãƒªã‚’"ç›—ã¿"ã€ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã®æ‰€æœ‰æ¨©ï¼‰ã‚’**ç§»å‹•**ã•ã›ã‚‹

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€ã„ãã¤ã‹ã®è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚
1ã¤ã‚ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã®è¦ç´ ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã¯C++ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã§ã‚ã‚Šã€é€šå¸¸ã®Nimã®ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
2ã¤ã‚ã¯ãƒã‚¤ãƒ³ã‚¿ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’ç”¨æ„ã—ã¦æ–°ã—ã„æ›´æ–°ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€ã“ã‚Œã¯Javaã‚„C#ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã“ã‚Œã¯ã‹ãªã‚ŠåŠ¹çŽ‡ãŒæ‚ªãã€åˆ¥ã®é–“æŽ¥å‡¦ç†ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚‰ã§ã™ã€‚
3ã¤ã‚ã¯ã“ã‚Œã¯ä»£å…¥ãªã‚“ã ã‘ã©ã€æ‚ªã„ä»£å…¥ã ã‹ã‚‰ç¦æ­¢ã—ã¦ã—ã¾ãŠã†ã€ã¨ã„ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
4ã¤ã‚ã®è§£æ±ºç­–ã¯ã€å…ˆã»ã©è¨€ã£ãŸã‚ˆã†ã«ã€ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ã«ã“ã®æ‚ªã„ãƒã‚¤ãƒ³ã‚¿ã‚’æŽƒé™¤ã—ã¦ã‚‚ã‚‰ã†ã‹ã€ä»–ã®å¤‰æ•°ãŒãã‚Œã‚’å‚ç…§ã—ã¦ã„ãªã„å ´åˆã®ã¿ã€ãã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŽƒé™¤ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã§ã™ã€‚
æœ€å¾Œã¯ã€ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ç›—ã‚“ã§ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã—ã€ã“ã‚Œã¯C++ã§ã‚‚å¯èƒ½ã§ã™ã€‚ï¼ˆè¨³è€…æ³¨ï¼šC++ã§ã®ãƒ ãƒ¼ãƒ–ã®ã“ã¨ã€‚std::moveï¼‰

## æ˜Žç¤ºçš„ãªãƒ ãƒ¼ãƒ–
```nim
var someNumbers = @[1, 2]
var other = move(someNumbers)
# someNumbersã¯ç©ºã«ãªã£ãŸ
someNumbers.add 3

assert someNumbers == @[3]
```
ã“ã‚Œã¯æ˜Žç¢ºãªç§»å‹•ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Œã“ã®æ•°å­—ã‚’ä»–ã®æ•°å­—ã«ç§»å‹•ã•ã›ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã€ãã®å¾Œ"someNumbers"ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚ç©ºã®é…åˆ—ã«ãªã‚Šã¾ã™ã€‚
"someNumbers"ã«3ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãã®ä¸­ã«æ®‹ã£ã¦ã„ã‚‹ã®ã¯6è¡Œç›®ã§ã‚ã‹ã‚‹ã‚ˆã†ã«ã€"3"ãŒå…¥ã£ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚
ã“ã‚ŒãŒæ˜Žç¤ºçš„ãª"ãƒ ãƒ¼ãƒ–"ã§ã™ã€‚ã“ã®ã‚ˆã†ãªã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚
ã‚ã¾ã‚Šæ°—æŒã¡ã®ã„ã„ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ˜Žç¤ºçš„ã§ã‚ã‚Œã°ã€"someNumbers "ãŒç©ºã§ã‚ã‚‹ã“ã¨ã‚’æ„è­˜ã§ãã‚‹ã®ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
ã§ã‚‚ã€æš—é»™çš„ãª"ãƒ ãƒ¼ãƒ–"ãŒä½¿ã‚ã‚Œã‚‹å ´åˆã‚‚ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚

## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–
```nim
var a = f()
# é–¢æ•°fã®çµæžœã‚’aã«"ç§»å‹•"ã•ã›ã‚‹
```
æœ€åˆã®ä¾‹ã§ã™ã€‚é–¢æ•°å‘¼ã³å‡ºã—ã®çµæžœãŒã‚ã‚Œã°ã€ãã‚ŒãŒãã®å¾Œã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ã¯ãªã„ã¨ã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€å¤‰æ•°aã«ç›´æŽ¥ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–ï¼ˆ2ï¼‰
```nim
var namedValue = g()
var a = f(namedValue) # namedValueã‚’fã«ç§»å‹•ã§ãã‚‹
# fã®çµæžœã‚’aã«ç§»å‹•ã§ãã‚‹
```

ã¾ãŸã€ãã®å¾Œã«ä½¿ã‚ãªã„ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã‚‚ã€ç§»å‹•ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
è¨­è¨ˆä¸Šã®ç›®æ¨™ã®ã²ã¨ã¤ã¯ã€é–¢æ•°å‘¼ã³å‡ºã—ã®çµæžœãŒç§»å‹•ã§ãã‚‹ã“ã¨ãŒåˆ†ã‹ã£ã¦ã„ã‚‹å ´åˆã«ã€ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ã§ã—ãŸã€‚
ãŸã ã—ãã®çµæžœã‚’Nimã§èª­ã¿ã‚„ã™ãã€ã‹ã¤ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒãªã„ã‚ˆã†ã«ã—ãŸã„ã®ã§ã™ã€‚
"namedValue"ãŒãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§ã‚ã‚‹é™ã‚Šã€Nimã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯"namedValue"ãŒfé–¢æ•°ã®å‘¼ã³å‡ºã—ã«ä½¿ã‚ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€ãã‚Œä»¥é™ã«ä½¿ã‚ã‚ŒãŸã‚‚ã®ã§ã¯ãªã„ã“ã¨ã‚’èªè­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¨ã„ã†ã“ã¨ã¯ã€"namedValue "ã®å€¤ã‚’"f"ã«ç§»ã—ã€"f"ã®çµæžœã‚’ "a "ã«ç§»ã›ã°ã„ã„ã‚ã‘ã§ã™ã€‚

## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–ï¼ˆ3ï¼‰
```nim
var x = @[1, 2, 3]
var y = x # ã¯'x'ã®æœ€å¾Œã®å‘¼ã³å‡ºã—ãªã®ã§ã€'y'ã«ä»£å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
var z = y # ã¯'y'ã®æœ€å¾Œã®å‘¼ã³å‡ºã—ãªã®ã§ã€'z'ã«ä»£å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
```

ã‚‚ã†ã²ã¨ã¤ã®ä¾‹ã§ã™ã€‚
3ã¤ã®æ•´æ•°ãŒå…¥ã£ãŸé…åˆ—ãŒã‚ã‚Šã€yãŒxã ã¨ã™ã‚‹ã¨ã€xã¯ã‚‚ã†ä½¿ã‚ã‚Œã¦ã„ãªã„ã®ã§ã€ãƒ ãƒ¼ãƒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
åŒæ§˜ã«ã€zã«ä»£å…¥ã•ã‚Œã‚‹yã‚‚ãƒ ãƒ¼ãƒ–ã§ãã¾ã™ã€‚
ã“ã‚Œã¯ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®å ´åˆã«ä½¿ãˆã¾ã™ã€‚

## Sinkå¼•æ•°
```nim
func put(t: var Table; key: string; value: seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ã‚³ãƒ”ãƒ¼ã‚’è¡Œã£ã¦ã„ã‚‹ (Â´ï½¥Ï‰ï½¥`)

var values = @["a", "b", "c"]
tab.put("key", values)
```

ã“ã“ã§ã€puté–¢æ•°ã«æ¸¡ã•ã‚ŒãŸå¼•æ•°ãŒãã®å¾Œã§ä½¿ã‚ã‚Œã‚‹ã‹ã©ã†ã‹ã‚ã‹ã‚‰ãªã„ã¨ã„ã†å•é¡Œã‚’å¼•ãèµ·ã“ã™å ´åˆã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã®ä¾‹ã¯ã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®Ÿè£…ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚
æ™®é€šã¯2è¡Œä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚
ã“ã®ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’`t`ã«ç§»å‹•ã•ã›ãŸã„å ´åˆã¯ã€ãã®å€¤ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¾ã™ã€‚
ãã—ã¦ã€ç¾åœ¨ã®ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã‚’è€ƒãˆã‚‹ã¨ã€ã“ã‚Œã¯ãƒã‚¤ã‚³ã‚¹ãƒˆãªã‚³ãƒ”ãƒ¼æ“ä½œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ2ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
tab.put("key", values) # valueã®æœ€å¾Œã®ä½¿ç”¨ç®‡æ‰€ãªã®ã§ã€ãƒ ãƒ¼ãƒ–ãŒã§ãã‚‹
```
ã—ã‹ã—ã€ã“ã®å¼•æ•°ã«sinkã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã¨ã€ãã®å¾Œã«ã‚‚ã†ä½¿ã£ã¦ã¯ã„ã‘ãªã„ã¨ã„ã†åˆ¶ç´„ãŒã§ãã€å‘¼ã³å‡ºã—å…ƒã«ã‚‚å¼·åˆ¶ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«ã€åŒã˜å¼•æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã®å¾Œã«ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã‚Šã€3è¡Œç›®ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®å†…éƒ¨ã§ãƒ ãƒ¼ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚
ã¤ã¾ã‚Šã€3ã¤ã®æ–‡å­—åˆ—ã‚’å†…éƒ¨ã«æŒã¤ãƒªã‚¹ãƒˆã®ã‚ˆã†ãªå€¤ã‚’æŒã£ã¦ã„ã¦ã€ãã®å¾Œã«ãã‚Œã‚‰ã‚’ä½¿ç”¨ã—ãªã„å ´åˆãƒ ãƒ¼ãƒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ3ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
tab.put("key", values) # æœ€å¾Œã®å‘¼ã³å‡ºã—ã§ã¯ãªã„ã®ã§ã€ãƒ ãƒ¼ãƒ–ã§ããªã„
echo values

>> Warning: Passing a copy to a sink paramater.
```
ã‚‚ã—ã€ãã®å¾Œã«å€¤ã‚’ä½¿ã£ãŸã‚‰ã©ã†ãªã‚‹ã‹ã¨ã„ã†ã¨ã€ç§é”ã¯ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ‰€æœ‰æ¨©ã‚’å–å¾—ã—ãŸã„ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯è­¦å‘Šã‚’ç™ºã—ã€ã€Œã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å¾Œã§ä½¿ç”¨ã•ã‚Œã‚‹ã®ã§ã€å®‰å…¨ã®ãŸã‚ã«ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€ã¨ä¼ãˆã¾ã™ã€‚
ã“ã‚Œã¯è¨­è¨ˆåŸºæº–ã«ã‚‚ãªã£ã¦ã„ã¦ã€ã‚‚ã—é–“é•ãˆã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒè½ã¡ã¾ã™ãŒã€å¤‰ãªã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã¯ã›ãšã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯æ€§èƒ½é¢ã«ã¤ã„ã¦è­¦å‘Šã‚’å‡ºã—ã¾ã™ã€‚
ãŸã ã€ã“ã®è­¦å‘Šã¯ã¡ã‚‡ã£ã¨å¼·å¼•ã™ãŽã‚‹ã‚ˆã†ãªæ°—ã‚‚ã™ã‚‹ã®ã§ã€ã‚‚ã†å°‘ã—æ”¹å–„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ4ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
echo values
tab.put("key", values)

>> Solution: Move code around.
```
ã“ã“ã§1ã¤ã®è§£æ±ºç­–ã¯ã€ãã‚Œã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ã§ã™ã€‚
ã“ã®ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åŸ‹ã‚è¾¼ã‚€å‰ã«å€¤ã‚’echoã—ã¦ãŠã‘ã°ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯echoãŒå€¤ã®æ‰€æœ‰æ¨©ã‚’æŒã¡ãŸããªã„ã¨çŸ¥ã£ã¦ã„ã‚‹ã®ã§ã€ã†ã¾ãã„ãã¯ãšã§ã™ã€‚
tab.putã¯sinkã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŠã‹ã’ã§ã€valuesãŒãã®å¾Œã§å‘¼ã³å‡ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€ã“ã‚Œã¯ä¸€ã¤ã®è§£æ±ºç­–ã§ã€ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã ã‘ãªã‚‰ã€ã‚³ãƒ”ãƒ¼ãŒå¢—ãˆã‚ˆã†ãŒå¢—ãˆã¾ã„ãŒæ°—ã«ã™ã‚‹å¿…è¦ã¯ãªã„ã§ã—ã‚‡ã†ã€‚ãªãœãªã‚‰ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãã®å¾Œã™ãã«å‰Šé™¤ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚

## Sinkã®ãã®ä»–ã®ä¾‹
- sinkå¼•æ•°ã¯æœ€é©åŒ–ã®ãŸã‚ã®ã‚‚ã®ã§ã™
- é–“é•ãˆãŸå‘¼ã³å‡ºã—æ–¹ã‚’ã™ã‚‹ã¨ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«å½±éŸ¿ãŒå‡ºã¾ã™ã€‚
```nim
func `[]=`[K, V](t: var Table[K, V]; k: K, v: V)
func `==`[T](a, b: T):bool
func `+`[T](a, b: T): T
func add[T](s: var seq[T]; v: T)
```

sinkå¼•æ•°ã¯æœ€é©åŒ–ã®ãŸã‚ã®ã‚‚ã®ã§ã‚ã‚Šã€ç„¡ç†ã«ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã‚‚ã—é–“é•ãˆã‚‹ã¨ã€ä»¥å‰ã‚ˆã‚Šæ€§èƒ½ãŒæ‚ªããªã‚Šã¾ã™ãŒã€æ­£ã—ãä½¿ãˆã°ã€ã‚ˆã‚Šè‰¯ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚
ã¾ãŸã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹å¿…è¦ãŒãªã„ã‚ˆã†ã«ã€æ…Žé‡ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™ã€‚
ã¨ã„ã†ã®ã‚‚ã€å®Ÿéš›ã«æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚ã¡ã“ã¡ã«ã‚·ãƒ³ã‚¯ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã€Œãã‚“ãªã“ã¨ã¯ã—ãªã„ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒè§£æ±ºã—ã¦ãã‚Œã‚‹ã€ã¨è¨€ã‚ã‚Œã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚
ã¨ã„ã†ã‚ã‘ã§ã€ã„ãã¤ã‹å¥½ããªä¾‹ã‚’æŒ™ã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã€æŒ¿å…¥ã‚„æ›´æ–°ã®ãŸã‚ã®ã‚»ãƒƒã‚¿ãƒ¼ã€ã‚ã‚‹ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹åž‹Tã‚’æ¯”è¼ƒã™ã‚‹ã‚¤ã‚³ãƒ¼ãƒ«ã€Tã®åŠ ç®—ã€æœ€å¾Œã«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¸ã®è¿½åŠ ã§ã™ã€‚
å•é¡Œã¯sinkã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã©ã“ã«ç½®ãã‹ã¨ã„ã†ã“ã¨ãªã‚“ã§ã™ãŒã€ã“ã‚Œã¯æŽ¨æ¸¬ã™ã‚‹ã¾ã§ã‚‚ãªãã€ç§ãŒæ•™ãˆã¦ã‚ã’ã¾ã™ã€‚

## Sinkã®ãã®ä»–ã®ä¾‹ï¼ˆ2ï¼‰
```nim
func `[]=`[K, V](t: var Table[K, V]; k: sink K, v: sink V)
func `==`[T](a, b: T):bool
func `+`[T](a, b: T): T
func add[T](s: var seq[T]; v: sink T)
```

ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«å€¤ã‚’åŸ‹ã‚è¾¼ã‚€ã«ã¯sinkã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã€é…åˆ—ã¸ã®è¿½åŠ ã‚‚sinkã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚
ã“ã‚Œã‚‰ã¯ã€æœ€åˆã®è¡Œã¸ã®æŒ¿å…¥ã‹æ›´æ–°ã‹ã®ã‚½ãƒ¼ãƒˆã§ã™ã€‚
ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ã™ã‚‹å ´åˆã¯ã€ã‚­ãƒ¼ã®æ‰€æœ‰æ¨©ã‚’å–å¾—ã—ãŸã„ã®ã§ã™ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã ã‘ã§ã‚ã‚Œã°ã€ã‚­ãƒ¼ã¯ã™ã§ã«æŒã£ã¦ã„ã¾ã™ã€‚
ãã®çµæžœã©ã†ãªã‚‹ã‹ã¨ã„ã†ã¨ã€sinkã‚’ä»˜ã‘ã‚‹ã¹ãã‹ã©ã†ã‹ã€ãã‚Œã¯ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚
ã—ã‹ã—sinkã‚’ä»˜ã‘ã‚‹ã¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã§ã“ã®å€¤ãŒæ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ãŒã€ãã“ã¾ã§ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã—ã¦ã€ä½•ã‹ã‚’æ¶ˆè²»ã™ã‚‹ã¨ã„ã†ã®ã¯ã©ã†ã„ã†ã“ã¨ãªã®ã‹ã¨ã„ã†æ¦‚å¿µãŒã‚ã‚‹ã®ã§ã€ã„ãšã‚Œã«ã›ã‚ˆãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ã¤ã„ã¦èª¬æ˜Žã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨
```nim
func get[K, V](t:Table[K, V]; key: K): V =
  var h = hash(key)
  result = t.slots[h] # ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã‚‹ï¼Ÿ
```
ã“ã“ã§ã¯åˆ¥ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã„ã‚ã„ã‚ãªã‚‚ã®ã‚’å…¥ã‚Œã‚‹ã®ã¯éžå¸¸ã«åŠ¹æžœçš„ã§ã„ã„ã®ã§ã™ãŒã€ãã“ã‹ã‚‰å€¤ã‚’å–ã‚Šå‡ºã™ã®ã¯ã©ã†ã—ãŸã‚‰ã„ã„ã§ã—ã‚‡ã†ã‹ã€‚
ã“ã®ä¾‹ã‚‚ã¾ãŸåŒã˜å•é¡Œã§ã™ã€‚ã“ã®å ´åˆã®resultã¯Nimã§ã¯returnæ–‡ã¨åŒã˜ã§ã™ãŒã€ã“ã‚Œã¯ãƒã‚¤ã‚³ã‚¹ãƒˆãªã‚³ãƒ”ãƒ¼ã§ã‚ã‚‹ã“ã¨ãŒã‚ˆã‚Šæ˜Žç™½ã«ãªã‚‹ã‚ˆã†ã«ã€ç§ã¯ãã‚Œã‚’ä»£å…¥ã¨ã—ã¦æ›¸ãã¾ã—ãŸã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ2ï¼‰
```nim
func get[K, V](t:Table[K, V]; key: K): V =
  var h = hash(key)
  result = move(t.slots[h]) # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
```
ã“ã®ã‚½ãƒ¼ã‚¹ã‚’ãƒ ãƒ¼ãƒ–ã•ã›ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯Tã¯ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ãªãã€ãƒ ãƒ¼ãƒ–ã¯ã“ã®å¤§å…ƒ(å¤‰æ•°t)ã‚’å¤‰ç•°ã•ã›ã‚‹ã‹ã‚‰ã€ãƒ ãƒ¼ãƒ–ã§ããªã„ã€ã¨æ–‡å¥ã‚’è¨€ã†ã§ã—ã‚‡ã†ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ3ï¼‰
```nim
func get[K, V](t:var Table[K, V]; key: K): V =
  var h = hash(key)
  result = move(t.slots[h]) # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ãŒã€ã‹ãªã‚Šå±é™º
```
ã§ã¯ãã‚Œã‚’ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã‚Œã¯ã†ã¾ãã„ãã®ã§ã™ãŒã€ä»Šåº¦ã¯ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å€¤ã‚’ç§»å‹•ã•ã›ãŸã¨ãã«ä½•ãŒèµ·ã“ã‚‹ã‹ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã¯ä¸€åº¦ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã€ãã®å¾Œã¯æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚
ã“ã‚Œã¯ã‹ãªã‚Šã¾ãšã„ã§ã™ã­ã€‚
ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒãƒƒãƒ—ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°è©±ã¯åˆ¥ã§ã™ãŒã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆã¯ã‹ãªã‚Šã¾ãšã„ã§ã™ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ4ï¼‰
```nim
func get[K, V](t: Table[K, V]; key: K): lent V =
  var h = hash(key)
  result = t.slots[h] # ã‚³ãƒ”ãƒ¼ã§ã‚‚ãƒ ãƒ¼ãƒ–ã§ã‚‚ãªãã€"å€Ÿç”¨"
```
ç§é”ã«ã¯å€¤ã‚„é•·ã•Vã‚’è²¸ã—å‡ºã™åˆ¥ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã€ã“ã‚Œã¯å€Ÿç”¨ã§ã™ã€‚
Rustã§ã¯ã€ã“ã‚Œã¯å€Ÿç”¨ã‚³ãƒ”ãƒ¼ãƒã‚¤ãƒ³ã‚¿ã«ãªã‚Šã¾ã™ã€‚C++ã§ã¯refã§ã™ãŒå®Ÿæ…‹ã¯åŒã˜ã‚‚ã®ã§ã™ã€‚
ä¸€æ—¦å€Ÿç”¨ã—ãŸã‚‰ã€ã“ã‚ŒãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã‚ˆã‚Šé•·ããªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¤ã¾ã‚Šã€Rustã§ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œã€C++ã§ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚Nimã§ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ãŒã€ã‚‚ã£ã¨ã†ã¾ãã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
- ã“ã‚Œã¾ã§ã©ã®ã‚ˆã†ã«æœ€é©åŒ–ãŒå½ã®ã‚³ãƒ”ãƒ¼ã‚’å–ã‚Šé™¤ãã‹ã‚’è¦‹ã¦ãã¾ã—ãŸ
- åŒã˜åŽŸç†ãŒå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ(=RC)ã«ã‚‚é©ç”¨ã•ã‚Œã¾ã™
- å‚ç…§ã®ã‚³ãƒ”ãƒ¼ â†’ incRc(src); decRc(dest); dest = src
- å‚ç…§ã®ç§»å‹• â†’ dest = src
- ã“ã‚ŒãŒ`--gc:arc`ãƒ¢ãƒ¼ãƒ‰ã®é–‹ç™ºã«ã¤ãªãŒã‚Šã¾ã—ãŸ

ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ãªã©è¤‡é›‘ãªä»£å…¥ã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•ã‚’ç†è§£ã—ãŸä»Šã€ã“ã®çŸ¥è­˜ã‚’ä»–ã®ã‚‚ã®ã«å¿œç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä¾‹ãˆã°å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚
å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã¯åŸºæœ¬çš„ã«ã€ãƒã‚¤ãƒ³ã‚¿ã®å‰²ã‚Šå½“ã¦ãŒä»¥å‰ã‚ˆã‚Šãšã£ã¨ãƒã‚¤ã‚³ã‚¹ãƒˆã«ãªã£ãŸã ã‘ã§ã™ã€‚ãªãœãªã‚‰ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹å ´åˆã€ã‚½ãƒ¼ã‚¹ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ãªã‘ã‚Œã°ãªã‚‰ãšã€ãã—ã¦ã‚³ãƒ”ãƒ¼å…ˆã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒã‚¤ãƒ³ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚‚ã§ãã¾ã™ãŒã€ã‚‚ã—ãƒã‚¤ãƒ³ã‚¿ã‚’ãƒ ãƒ¼ãƒ–ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ãƒ“ãƒƒãƒˆå˜ä½ã®ã‚³ãƒ”ãƒ¼ã§æ¸ˆã¿ã¾ã™ã—ã€å¿…è¦ã§ã‚ã‚Œã°ã€ãã®å¾Œã‚½ãƒ¼ã‚¹ã‚’nilã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ã“ã‚Œã¯ã¤ã¾ã‚ŠGCã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ãŒã€GCã¯å®Ÿéš›ã«ã¯ã‚ã‚‰ã‚†ã‚‹ç¨®é¡žã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã®ãŸã‚ã®åå‰ãªã®ã§ã™ã€‚

## ARC
```nim
include prelude

type
  Node = ref object
    le, ri: Node

proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(depth: int): Node =
  if depth == 0: Node(le: nil, ri: nil)
  else: Node(le: makeTree(depth-1), ri: makeTree(depth-1))
```
ã“ã“ã«ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ãƒã‚¤ãƒŠãƒªã§ã™ã€‚ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®æ¨™æº–çš„ãªãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã™ã€‚
ã“ã®ã™ã¹ã¦ã‚’ç†è§£ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã§ã‚‚é‡è¦ãªã®ã¯ã€ã“ã“ã«ã¯`sink`ã‚„`lent`ã®ã‚ˆã†ãªã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒãªã„ã“ã¨ã§ã™ã€‚
ãƒã‚¤ãƒŠãƒªãƒ„ãƒªãƒ¼ã‚’ä½œã£ã¦ã€ãã‚Œã‚’ä½•å…†å€‹ã‚‚ä½œã£ã¦ã„ã‘ã°ã€ã‚ã‚‹ç¨‹åº¦ã®æ·±ã•ã¾ã§åˆ°é”ã—ã¾ã™ã€‚

## ARC(2)
```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  echo("stretch tree of depth ", stretchDepth, "\t check: ", checkTree(makeTree(stretchDepth)))
  let longLivedTree = makeTree(maxDepth)
  var iterations = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterations:
      check += checkTree(makeTree(depth))
    echo iterations, "\t trees of depth ", depth
    iterations = iterations div 4

main()
```
ã“ã‚ŒãŒãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹éƒ¨åˆ†ã§ã™ãŒã€æ¨™æº–çš„ãªãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã€çµæžœã¯å®Ÿã«ç´ æ™´ã‚‰ã—ã„ã‚‚ã®ã§ã™ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|**6.75s**|472.098MiB|

ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãŒã„ãã¤ã‹ã‚ã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’ã™ã¹ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã—ã€æ–°ã—ã„ã‚‚ã®ã¯ã€3å€ã¨ã‹2å€ã¨ã‹ã€æ¯”è¼ƒã—ãŸã„ã‚‚ã®ã«ã‚ˆã£ã¦ã‹ãªã‚Šé«˜é€Ÿã«ãªã‚Šã¾ã™ã€‚
ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚‚bohemã®GCã¨ã»ã¼åŒã˜ã§ã™ãŒã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚’æ­£ç¢ºã«æŠŠæ¡ã§ãã¦ã„ãªã„ã®ã§ã€ãã®ç‚¹ã¯ä¸æ˜Žã§ã™ã€‚
å•é¡Œã¯ã€ã“ã‚ŒãŒä»¥å‰ã‚ˆã‚Šéžå¸¸ã«è‰¯ããªã£ãŸã¨ã„ã†ã“ã¨ã§ã™ãŒã€æ‰‹å‹•ã§ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã¨æ¯”ã¹ã¦ã©ã†ãªã®ã‹ã§ã™ã€‚

## æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†
```nim
include prelude

type
  Node = ptr object
    le, ri: Node

proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(depth: int): Node =
  result = cast[Node](alloc(sizeof(result[]))) # 12è¡Œç›®
  if depth == 0:
    result.le = nil; result.ri = nil
  else:
    result.le = makeTree(depth-1)
    result.ri = makeTree(depth-1)

proc freeTree(n: Node) =
  if n != nil:
    freeTree(n.le); freeTree(n.ri); dealloc(n)
```

Nimã¯ä¸¡æ–¹ã§ãã‚‹ã®ã§ã€è‡ªåˆ†ã§ãƒã‚¤ãƒ³ã‚¿ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥å‰ã¯ã“ã‚Œã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã®å‚ç…§ã§ã—ãŸãŒã€ä»Šã¯ãƒã‚¤ãƒ³ã‚¿ã«ãªã‚Šã€ãƒ„ãƒªãƒ¼ã‚’ä½œã‚‹ãŸã‚ã«12è¡Œç›®ã§ã‚­ãƒ£ã‚¹ãƒˆã‚’ä½¿ã£ãŸåŽ„ä»‹ãªå‰²ã‚Šå½“ã¦ã‚’ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ãƒ„ãƒªãƒ¼ã‚’æ‰‹å‹•ã§è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯å†å¸°çš„è§£æ”¾ã§ã€ã¾ãšå·¦ã‚’è§£æ”¾ã—ã€æ¬¡ã«å³ã‚’è§£æ”¾ã—ã¦ã€ã“ã®ãƒŽãƒ¼ãƒ‰ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

## æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼ˆ2ï¼‰

```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  let stree = makeTree(stretchDepth)
  echo("stretch tree of depth ", stretchDepth, "\t check:",
    checkTree(stree))
  let longLivedTree = makeTree(maxDepth)
  var iterations = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterations:
      let tmp = makeTree(depth)
      check += checkTree(makeTree(tmp))
      freeTree(tmp) # 15è¡Œç›®
    echo iterations, "\t trees of depth ", depth
    iterations = iterations div 4
  freeTree(longLivedTree); freeTree(stree) # 18è¡Œç›®

main()
```
ãã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ„ãƒªãƒ¼ã‚’æ‰‹å‹•ã§è§£æ”¾ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ä¾‹ãˆã°18è¡Œç›®ã§ã¯éžå¸¸ã«åŽ„ä»‹ãªå‡¦ç†ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚
æ›´ã«15è¡Œç›®ã§ã¯ã€å¾Œã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«tmpå¤‰æ•°ã‚’è§£æ”¾ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|**6.75s**|472.098MiB(379.074MiB)|
|manual|5.23s|244.563MiB|
|manual(with RC)|6.244s|379.074MiB|

ã“ã‚ŒãŒãã®çµæžœã§ã™ã€‚ã¾ã é…ã„ã§ã™ã­ã€æ®‹å¿µã§ã™ã€‚
ã—ã‹ã—ARCãŒå®Ÿéš›ã«ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ€é©åŒ–ã™ã‚‹ã“ã¨ã§ã€ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ç‰ˆã§ã¯ã‚¹ãƒžãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚‹ã®ã§åŸºæœ¬çš„ã«å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã¯ã—ã¦ã„ã¾ã›ã‚“ã€‚
ã“ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã®ãŸã‚ã«ãƒžã‚·ãƒ³ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ãŸå ´åˆã€ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ç‰ˆã§ã¯6.2ç§’ã¨ã»ã¼åŒã˜ã«ãªã‚Šã¾ã™ãŒã€ARCã¯6.7ç§’ã«ãªã‚Šã¾ã™ã€‚
ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã¯ã€æ®‹ã£ã¦ã„ã‚‹ã“ã®1ã¤ã‚’ç›´ã—ãŸã¨ã„ã†å‰æã§åŒã˜ã§ã™ã€‚
æ‰‹å‹•ã§ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«è¿‘ã¥ãã¤ã¤ã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã“ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã¯ã€èª¤å·®ãƒ¬ãƒ™ãƒ«ã«ãªã‚‹ã¾ã§ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
|Memory management strategy|Latency|Total Time|Peak Memory|
|---|---|---|---|
|defferd refcountng GC|0.0356ms|0.314s|300MiB|
|ARC|0.0106ms|0.254s|271MiB|

ã“ã¡ã‚‰ã¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®ãŸã‚ã®åˆ¥ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã™ã€‚
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä»¥å‰ã¯ã‚½ãƒ•ãƒˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ã£ã¦ã„ã¦ã€ã“ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¯0.03ãƒŸãƒªç§’ã§ã—ãŸã€‚
ãã‚ŒãŒARCã§ã¯3å€ä»¥ä¸Šæ”¹å–„ã•ã‚Œã€ç·å®Ÿè¡Œæ™‚é–“ã‚‚çŸ­ç¸®ã•ã‚Œã¾ã—ãŸã€‚
ã¾ãŸã€ãƒ”ãƒ¼ã‚¯æ™‚ã®ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚‚æ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã ã‘ã§ãªãã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚‚å‘ä¸Šã—ã¦ã„ã¾ã™ã€‚

## ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒŠ
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã€ä»£å…¥ã¨ç§»å‹•ã®æœ€é©åŒ–
- ãƒ•ã‚¡ã‚¤ãƒ«/ã‚½ã‚±ãƒƒãƒˆãªã©ã‚’è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã§ãã‚‹ï¼ˆC++ã‚„Rustã®ã‚ˆã†ã«ï¼‰
- ç‰¹æ®Šãªãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã‚’åˆä½“ã§ãã‚‹

ã™ã§ã«æ¦‚è¦ã‚’èª¬æ˜Žã—ã¾ã—ãŸãŒã€ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ä¸­ã§ä½•ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚„ãƒ ãƒ¼ãƒ–ã®æ¼”ç®—å­ã€ä»£å…¥ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚‰ã‚’ä»–ã®ã¨ã“ã‚ã«ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ã™ãã«æ€ã„ã¤ãã‚ˆã†ã«ã€ä¾‹ãˆã°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«é–‰ã˜ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ä»¥å‰ã¯æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ã¨GCãƒ¡ãƒ¢ãƒªç®¡ç†ãŒã‚ã‚Šã¾ã—ãŸãŒã€æ··åœ¨ã•ã›ã‚‹ã¨ã†ã¾ãæ©Ÿèƒ½ã—ãªã„ã®ã§æ³¨æ„ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã—ã‹ã—ã“ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã£ã¦ã€ã“ã‚Œã‚‰æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ã¨GCã®ä¸–ç•Œã®é–“ã¸ã®å‰²ã‚Šè¾¼ã¿ãŒä»¥å‰ã‚ˆã‚Šãšã£ã¨ã‚ˆããªã‚Šã¾ã—ãŸã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«
```nim
include prelude

type
  NodeObj = object
    le, ri: Node
  Node = ptr NodeObj

  PoolNode = object
    next: ptr PoolNode
    elems: UncheckedArray[NodeObj]

  Pool = object
    len: int
    last: ptr PoolNode
    lastCap: int
```

ã“ã“ã§ã‚‚ã†ã²ã¨ã¤ã€ç§é”ã«ã¯ã¾ã ã§ãã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
åŒã˜ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã™ãŒ ä»Šåº¦ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚ã‚¢ãƒªãƒ¼ãƒŠã¨å‘¼ã³ã¾ã—ã‚‡ã†ã€‚
ã‚¢ãƒªãƒ¼ãƒŠã®ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã¯ã€å†…éƒ¨ã«2ã¤ã®ãƒã‚¤ãƒ³ã‚¿ã—ã‹æŒãŸãªã„3ã¤ã®ãƒŽãƒ¼ãƒ‰ã‚’æ‰±ã£ã¦ã„ã¾ã™ã€‚

â€»è¨³è€…æ³¨ï¼š
C++ã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã«ã€ŒArena Allocationã€ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã€ã“ã‚Œã¯Nimã§ã®å®Ÿè£…ã§ã‚ã‚‹ã€‚

> Project Snowflake ã«ä»£ã‚ã£ã¦1ã¤æœ‰æœ›è¦–ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€ Arena Allocation ã¨ã„ã†æ‰‹æ³•ã§ã™ã€‚
> [Protocol Buffersã® C++ ç‰ˆ](https://developers.google.com/protocol-buffers/docs/reference/arenas)ãŒã“ã®æ‰‹æ³•ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’æä¾›ã—ã¦ã„ã‚‹ã‚“ã§ã™ãŒã€ãã‚Œã‚’ .NET ã«ã‚‚å°Žå…¥ã§ããªã„ã‹ã¨ã„ã†èª¿æŸ»ã‚’ã—ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚ ã¾ã ã‚ã‚“ã¾ã‚Šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªãã€QConSFã®ç™»å£‡ã§è»½ãç´¹ä»‹ã•ã‚ŒãŸç¨‹åº¦ã§ã™ãŒã€‚
> [CLR/CoreCLR: How We Got Here & Where We're Going](https://qconsf.com/sf2018/presentation/clrcoreclr-how-we-got-here-where-were-going)
> ã“ã‚Œã‚‚ã€ã€Œã‚ã‚‹ç¨‹åº¦ã¾ã¨ã¾ã£ãŸå˜ä½ã§ã”ã£ãã‚Šå‡¦ç†ã™ã‚‹æ–¹ãŒé«˜åŠ¹çŽ‡ã€ã¨ã„ã†åŽŸç†ã«å‰‡ã£ãŸã‚‚ã®ã§ã™ã€‚ ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ã€Œã”ã£ãã‚Šæ¶ˆã™ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜Žç¤ºã™ã‚‹ã‚ˆã†ãªæ–¹å¼ã€‚ ãƒ¡ãƒ¢ãƒªæ”¾æ£„ã®ã¾ã¨ã¾ã£ãŸå˜ä½ã‚’æŒ‡ã—ã¦ arena (èˆžå°ã€ç«¶æŠ€å ´ã€ç•Œ)ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚

å¼•ç”¨å…ƒï¼šhttps://ufcpp.net/blog/2018/12/futurememorymanagement/


## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ2ï¼‰
```nim
proc newNode(p: var Pool): Node =
  if p.len >= p.lastCap:
    if p.lastCap == 0: p.lastCap = 4
    elif p.lastCap < 65_000: p.lastCap *= 2
    var n = cast[ptr PoolNode](alloc(sizeof(PoolNode) *
      p.lastCap * sizeof(NodeObj)))
    n.next = nil
    n.next = p.last
    p.last = n
    p.len = 0
  result = addr(p.last.elems[p.len])
  p.len += 1
```

æ–°ã—ã„ãƒŽãƒ¼ãƒ‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã«ã¯ã€åŸºæœ¬çš„ã«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ã‚ˆã†ã«å®¹é‡ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
ãã—ã¦ãƒŽãƒ¼ãƒ‰è‡ªä½“ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ãƒã‚¤ãƒ³ã‚¿ãªã®ã§ã€ãƒŽãƒ¼ãƒ‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ã‚ã‚‹é…åˆ—ã®è¦ç´ ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ3ï¼‰
```nim
proc `=`(dest: var Pool; src: Pool) {.error.}

proc `=destroy`(p: var Pool) =
  var it = p.last
  while it != nil:
    let next  = it.next
    dealloc(it)
    it = next
  p.len = 0
  p.lastCap = 0
  p.last = nil
```

ã“ã“ã§ã‚‚ã—ãƒ—ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã„ã®ã§ã‚ã‚Œã°ã€ãã‚Œã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã®ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚
ã•ã‚‰ã«ã€èª¤ã£ã¦ãƒ—ãƒ¼ãƒ«ã‚’ä¸¸ã”ã¨ã‚³ãƒ”ãƒ¼ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯æ–‡å¥ã‚’è¨€ã£ã¦ã€Œã§ããªã„ã€ã¨è¨€ã†ã§ã—ã‚‡ã†ã€‚
ãã—ã¦ãƒ—ãƒ¼ãƒ«ãŒã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ã¨ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã°ã‚Œã‚‹ã®ã§ã™ãŒã€ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä½•ã‚’ã™ã‚‹ã‹ã¨ã„ã†ã¨ã“ã‚Œã‚‰ã®ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã—ã¾ã™ã€‚ã—ã‹ã—ã“ã‚Œã‚‰ã¯ã“ã®æ¬¡ã®ãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚‹ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã«é€£çµã•ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ4ï¼‰
```nim
proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(p:var Pool; depth: int): Node =
  result = newNode(p)
  if depth == 0:
    result.le = nil
    result.ri = nil
  else:
    result.le = makeTree(p, depth-1) # 11è¡Œç›®
    result.ri = makeTree(p, depth-1) # 12è¡Œç›®
```

ãã†ã™ã‚‹ã¨æ®‹å¿µãªãŒã‚‰ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã§ã™ã‹ã‚‰ã‚‚ã—ãƒ„ãƒªãƒ¼ã‚’ä½œã‚ŠãŸã„ã®ã§ã‚ã‚Œã°ã€ã“ã®ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æ–°ã—ã„ãƒŽãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚’æ„è­˜ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ã“ã‚Œã¯ãƒ„ãƒªãƒ¼ã‚’ä½œã‚‹ã¨ãã®å¼•æ•°ã«ãªã‚Šã€11è¡Œç›®ã€12è¡Œç›®ã«ã‚ã‚‹ã‚ˆã†ã«ã€å†å¸°çš„ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ5ï¼‰
```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  var longLived: Pool # 5è¡Œç›®
  let stree = makeTree(longLived, maxDepth)
  echo("stretch tree of depth ", stretchDepth, "\t check ",
    checkTree(stree))
  let longLivedTree = makeTree(longLived, maxDepth)
  var iterators = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterators:
      var shortLived: Pool # 14è¡Œç›®
      check += checkTree(makeTree(shortLived, depth))
    echo iterators, "\t trees of depth ", depth
    iterators = iterators div 4

main()
```

ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã¯ã“ã®ãƒ—ãƒ¼ãƒ«ã¯å¾Œã‹ã‚‰è‡ªå‹•çš„ã«è§£æ”¾ã•ã‚Œã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨ä½¿ã„ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚
ã“ã®å ´åˆã€5è¡Œç›®ã¨14è¡Œç›®ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€é•·å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ç”¨(longLived)ã¨çŸ­å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ç”¨ï¼ˆshortLivedï¼‰ã®2ã¤ã®ãƒ—ãƒ¼ãƒ«ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|6.75s|472.098MiB(379.074MiB)|
|manual|5.23s|244.563MiB|
|manual(with RC)|6.244s|379.074MiB|
|object pooling|**2.4s**|251.504MiB|

ãã®æ€§èƒ½ã¯ã©ã†ãªã£ãŸã§ã—ã‚‡ã†ã‹ã€‚
ãã®çµæžœã€2å€ä»¥ä¸Šã®æ€§èƒ½å‘ä¸Šã§ã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚‚ã»ã¼åŒã˜ã§ã—ãŸã€‚

## ã¾ã¨ã‚

- æ‰€æœ‰æ¨©ã®ç§»å‹•ã¯é–‹ç™ºè€…ã«ã¯è¦‹ãˆãªã„ã¨ã“ã‚ã§å‹•ãã¾ã™
- `sink` ã¨ `lent` ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ä»»æ„ã§ã™
- ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ”¹è‰¯ã«ã¤ãªãŒã‚Šã¾ã™
- Nim ã‚’ã‚ˆã‚Šé€Ÿãã€"æ±ºå®šè«–çš„"ã«ã—ã¾ã™
- æ–°ã—ã„æˆ¦ç•¥ãŒä»¥ä¸‹ã‚’æ”¹å–„ã—ã¾ã™
  - å‡¦ç†é€Ÿåº¦
  - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
  - ãƒ¡ãƒ¢ãƒªæ¶ˆè²»
  - ã‚¹ãƒ¬ãƒƒãƒ‰
  - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å®¹æ˜“ã•
  - æŸ”è»Ÿãªæ§‹æˆ

è¦ç´„ã™ã‚‹ã¨ã€ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã¯ç§ãŸã¡ã«ã¯è¦‹ãˆãªã„ã¨ã“ã§åƒã„ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã™ã€‚
æœ¬å½“ã«è‰¯ã„æœ€é©åŒ–ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚
é€Ÿåº¦ãŒå‘ä¸Šã—ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’æ±ºå®šè«–çš„ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å®Ÿéš›ã“ã‚Œã¾ã§ã®ä¾‹ã§ã¯ã€å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ€é©åŒ–ã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã«ã‚³ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ä»˜åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸€åº¦ã“ã®æŠ€è¡“ã‚’ä½¿ãˆã°ã€Nimã‚’ãƒãƒ¼ãƒ‰ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®æŠ€è¡“ãŒã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã€ã‚¹ãƒ¬ãƒƒãƒ‡ã‚£ãƒ³ã‚°ãŒæ”¹å–„ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã¾ã—ãŸã€‚
ã¾ãŸã€å…·ä½“çš„ãªä¾‹ã¯ä»Šå›žã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä¾‹ãˆã°ã‚ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€RustãŒå®Ÿéš›ã«ãã†ã—ã¦ã„ã‚‹ã‚ˆã†ã«ã€ãƒ‡ãƒ¼ã‚¿ç«¶åˆãŒèµ·ããªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ã“ã¨ãŒæƒ³åƒã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã¯ã¨ã¦ã‚‚ç´ æ™´ã‚‰ã—ã„ã“ã¨ã§ã™ã€‚
ãã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«é–‰ã˜ã‚‰ã‚ŒãŸã‚Šã€ã‚½ã‚±ãƒƒãƒˆãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚Šã™ã‚‹ã®ã‚’è€ƒãˆã‚Œã°ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒã‚‚ã£ã¨ç°¡å˜ã«ãªã‚‹ã“ã¨ã‚‚æƒ³åƒã§ãã‚‹ã§ã—ã‚‡ã†ã€‚
ã¤ã¾ã‚Šã€ç§é”ã¯ç•°ãªã‚‹ã‚¯ãƒ©ã‚¹ã®é–“ã§ã‚ˆã‚Šè‰¯ã„æ§‹æˆãŒå¾—ã‚‰ã‚Œã‚‹ã®ã§ã™ã€‚

## Happy hacking!ãƒ¼ãƒãƒƒã‚¯ã‚’æ¥½ã—ã‚‚ã†ï¼
ä»Šå›žã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯æ¸¬å®šã«ä½¿ã£ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã‹ã‚‰è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
https://github.com/Araq/fosdem2020

|||
|---|---|
|Website|https://nim-lang.org/|
|Forum|https://forum.nim-lang.org/|
|Github|https://github.com/nim-lang/Nim|
|IRC|https://webchat.freenode.net/?channels=nim|

## è¨³è€…ã‚ã¨ãŒã
ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚ã“ã‚ŒãŒNimä½œè€…ã§ã‚ã‚‹AraqãŒæ±‚ã‚ã‚‹Nimã§ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã§ã™ã€‚
ã“ã®è¬›æ¼”ãŒè¡Œã‚ã‚ŒãŸ2020å¹´2æœˆ5æ—¥å½“æ™‚ã§ã¯ã¾ã ã“ã“ã§æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ARCã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã§ã—ãŸãŒã€ãã®å¾Œ2020å¹´4æœˆ3æ—¥ã®v1.2ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆã•ã‚Œã€2020å¹´10æœˆ16æ—¥ã®v1.4ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã¯ARCã‚’æ›´ã«å¾ªç’°å‚ç…§ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã—ãŸORCã¨ã„ã†ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚Araqã¯Nimã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã‚’å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ORCã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€æ—¥ã€…ç ”ç©¶ã‚’ç¶šã‘ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

Nimã§ã¯Rustã®æ‰€æœ‰æ¨©ãƒ¢ãƒ‡ãƒ«ã‚„C++ã®ã‚¹ãƒžãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã‚’ç”¨ã„ãŸãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãªã©å‚è€ƒã«ã—ã¦ã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒç™ºæ®ã§ãã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã¨ãªã£ã¦ã„ã¾ã™ã€‚
`sink`ã‚„`lent`ã¨è¨€ã£ãŸã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼•æ•°ã«å¯¾ã—ã¦ä½¿ã„ã€Rustã¨åŒã˜ãƒ¢ãƒ‡ãƒ«ã§æ‰€æœ‰æ¨©ã«åŸºã¥ããƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ã™ã‚Œã°ã€é€šå¸¸ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚ˆã‚Šã‚‚å¤§å¹…ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå‘ä¸Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
Nimã§ã¯ãã‚Œã‚’æ›´ã«é€²ã‚ã¦ã€ARCãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚Œã°ã€æ‰€æœ‰æ¨©ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦é–‹ç™ºè€…ãŒæ°—ã«ã—ã¦`sink`ã‚„`lent`ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒãªãã€åŒã˜ã ã‘ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

æ›´ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§ARCã‹ã‚‰3å€ã®åŠ¹çŽ‡åŒ–ãŒã§ãã¾ã™ã€‚ã“ã¡ã‚‰ã¯æ˜Žç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒå¿…è¦ã§ã™ãŒã€ç‰¹ã«ãƒãƒ¼ãƒ‰ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ å‘ã‘ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’èª­ã‚“ã èª­è€…ã®ä¸­ã‹ã‚‰ä¸€äººã§ã‚‚å¤šãNimã‚’ä½¿ã£ãŸé–‹ç™ºã‚’å§‹ã‚ã¦ãã‚Œã‚‹ã“ã¨ã‚’å¿ƒã‹ã‚‰é¡˜ã£ã¦ã„ã¾ã™ã€‚
