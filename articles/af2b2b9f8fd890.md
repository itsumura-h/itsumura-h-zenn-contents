---
title: "Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘¡ â€• Nimã®ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹"
emoji: "ðŸ‘‘"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nim", "GC", "ãƒ¡ãƒ¢ãƒªç®¡ç†"]
published: true
---

Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã¯ã“ã‚Œã¾ã§ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã„ãŸæ™‚ä»£ã‹ã‚‰ã€ARCã¨ã„ã†C++ã®ã‚¹ãƒžãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã‚„Rustã®æ‰€æœ‰æ¨©ã«åŸºã¥ã„ãŸæ‰‹æ³•ã‚’æŽ¡ç”¨ã—ã€å¤§å¹…ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã«æˆåŠŸã—ã¾ã—ãŸã€‚
ã—ã‹ã—ãã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ã¾ã ã‚ˆãç†è§£ã—ã¦ã„ã¾ã›ã‚“ã—ã€æ—¥æœ¬èªžã§ã®æƒ…å ±ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
ãã“ã§æ–°ã—ããªã£ãŸNimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã«ã¤ã„ã¦ç†è§£ã—ã€ãã®å†…å®¹ã‚’æ—¥æœ¬èªžã§ã¡ã‚ƒã‚“ã¨å…¬é–‹ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ã—ã‚ˆã†ã¨ã„ã†ã“ã¨ã§ã€æ˜”æ›¸ã„ãŸè¨˜äº‹ã‹ã‚‰ã‚·ãƒªãƒ¼ã‚ºåŒ–ã•ã›ãŸç¶šç·¨ã¨ã—ã¦ä»Šå›žã¯ä½œè€…ã®è¬›æ¼”ã®å…¨è¨³ã‚’ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

https://www.youtube.com/watch?v=yA32Wxl59wo

---

ã€œNimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹ã‚·ãƒªãƒ¼ã‚ºã€œ
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘  â€• Nimã®æ–°ã—ã„GCã€ARCã«ã¤ã„ã¦](https://qiita.com/dumblepy/items/be660c17556d73aa3570)
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘¡ â€• Nimã®ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹](https://zenn.dev/dumblepy/articles/af2b2b9f8fd890)
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘¢ â€• GCãªã—ã®Nim](https://zenn.dev/dumblepy/articles/0dcbc08aed1a25)
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘£ â€• ORC - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚‹ã‚¢ãƒ‰ãƒãƒ³ãƒ†ãƒ¼ã‚¸](https://zenn.dev/dumblepy/articles/efffa86d9177b1)
- [Nimã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’ç†è§£ã™ã‚‹â‘¤ â€• ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã¨ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿](https://zenn.dev/dumblepy/articles/92bdd7afe1fc29)

---

## ã¯ã˜ã‚ã«
"æ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’çœŸä¼¼ã™ã‚‹ã“ã¨ã¯è‰¯ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã¯ãªã„" -- Niméžå…¬å¼ãƒ¢ãƒƒãƒˆãƒ¼
- "æ‚ªã„è¨­è¨ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã¯ã„ã‘ãªã„ï¼"
- "ã„ãã¤ã‚‚ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®è‰¯ã„è¨­è¨ˆã‚’çµ„ã¿åˆã‚ã›ã‚ˆã†ï¼"

ã•ã¦ã€ç§ã¯Andreas Rumpfã€Nimã®å…ƒã€…ã®ç™ºæ˜Žè€…ã§ã‚ã‚Šã€ä»Šã‚‚ãªãŠãƒªãƒ¼ãƒ‰é–‹ç™ºè€…ã§ã™ã€‚ä»Šå›žã¯ã€Nimã«æ–°ãŸã«å°Žå…¥ã•ã‚Œã‚‹ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã«ã¤ã„ã¦ã®è©±ã‚’ã—ã¾ã™ã€‚ã“ã‚Œã¯Rustã‚„C++ã«è§¦ç™ºã•ã‚ŒãŸã‚‚ã®ã§ã‚ã‚Šã€æˆ‘ã€…ã¯ãã‚Œã‚’å†èª¿æ•´ã—ã¾ã—ãŸã€‚ãã‚Œã§ã¯ã€å§‹ã‚ã¾ã—ã‚‡ã†ã€‚

Nimã®éžå…¬å¼ãªãƒ¢ãƒƒãƒˆãƒ¼ã¯ã€ã€Œæ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã¯è‰¯ã„ãƒ‡ã‚¶ã‚¤ãƒ³ã§ã¯ãªã„ã€ã§ã™ã€‚
ã“ã‚Œã¯ã€ä½•ã‚’ã—ãªã„ã¹ãã‹ã‚’æ•™ãˆã¦ãã‚Œã‚‹ãŸã‚ã€éžå¸¸ã«æœ‰ç”¨ãªãƒ¢ãƒƒãƒˆãƒ¼ã§ã™ã€‚
ãã†ã§ã™ã­ã€æ‚ªã„ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä½•ã‚’ã—ãªã„ã¹ãã‹ã‚’çŸ¥ã‚‹ã‚ˆã‚Šã‚‚ã€ä½•ã‚’ã™ã¹ãã‹ã‚’çŸ¥ã‚‹ã“ã¨ãŒã‚‚ã£ã¨æœ‰ç”¨ã§ã™ã€‚
ãã“ã§ã€ã€Œã„ãã¤ã‹ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰è‰¯ã„éƒ¨åˆ†ã‚’å†çµ„ã¿åˆã‚ã›ã‚‹ã€ã¨è¨€ã„æ›ãˆã¾ã—ãŸã€‚
ç§ãŸã¡ã¯ã€Rustã‚„C++ã€ãã—ã¦SwiftãŒã©ã®ã‚ˆã†ã«ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’è¡Œã£ã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã€ã“ã‚Œã‚‰ã®æ¦‚å¿µãŒNimã«ã‚‚é©ç”¨ã§ãã‚‹ã‹ã©ã†ã‹ã‚’è¦‹ã¾ã—ãŸã€‚
ãã—ã¦ã€ãã®ç­”ãˆã¯ã€Œã¯ã„ã€ã ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
```nim
var someNumbers = @[1, 2]
someNumbers.add 3
```
ã“ã“ã«ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚ç§ã¯2ã¤ã®è¦ç´ ãŒå…¥ã£ãŸé…åˆ—ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ãã—ã¦ã€ãã®å¾Œã«æ•°å­—ã®3ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã¯æˆé•·ã™ã‚‹é…åˆ—ã§ã™ã€‚C++ã§ã¯ã“ã‚Œã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã¨å‘¼ã³ã€Nimã§ã¯ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã¨å‘¼ã³ã¾ã™ã€‚

## ãƒ¡ãƒ¢ãƒªä¸Šã§èµ·ãã¦ã„ã‚‹ã“ã¨
```
someNumbers

Length: 2     â”Œâ”€â”€> 1
Capacity: 2   â”‚    2
Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
ã§ã¯ã€ãƒ¡ãƒ¢ãƒªå†…ã§ä½•ãŒèµ·ã“ã‚‹ã‹ã‚’èª¬æ˜Žã—ã¾ã™ã€‚
ç§ãŸã¡ã¯ã“ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é…åˆ—ã‚’æŒã£ã¦ã„ã¦ã€å®Ÿéš›ã«ã¯é•·ã•ã¨å®¹é‡ãŒã‚ã‚Šã€æˆé•·å¯èƒ½ãªãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã¸ã®å˜ä¸€ãƒã‚¤ãƒ³ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ¡ãƒ¢ãƒªä¸Šã§èµ·ãã¦ã„ã‚‹ã“ã¨ï¼ˆ2ï¼‰
```
someNumbers

Length: 3     â”Œâ”€/â”€> 1
Capacity: 4   â”‚     2
Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚
              â””â”€â”€â”€â”€>1
                    2
                    3
```

æ•°å­—ã‚’è¿½åŠ ã™ã‚‹ã¨ãã€æ—¢ã«å®¹é‡ãŒã„ã£ã±ã„ã®å ´åˆï¼ˆãŸã¨ãˆã°2ã¤ã®è¦ç´ åˆ†ã®å®¹é‡ã—ã‹ãªã‹ã£ãŸå ´åˆï¼‰ã€3ã¤ã®æ•°å­—ã‚’ã™ã¹ã¦å«ã‚€ã®ã«ååˆ†ãªæ–°ã—ã„ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã—ã¦ã€å¤ã„ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã«å¯¾ã—ã¦ä½•ã‹ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é€šå¸¸ã€C++ã§ã¯ã“ã‚Œã‚’ã€Œreallocã€ã¨è¨€ã„ã€å¤ã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã™ãã«è§£æ”¾ã—ã¾ã™ã€‚

## æµ…ã„ã‚³ãƒ”ãƒ¼ã€ã‚³ãƒ”ãƒ¼ã€ãƒ ãƒ¼ãƒ–
```nim
var someNumbers = @[1, 2]
var other = someNumbers
someNumbers.add 3 # otherãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã£ã¦ã„ã‚‹
```

ã“ã‚Œã¯æœ€ã‚‚åŠ¹æžœçš„ãªæ–¹æ³•ã§ã™ãŒã€å•é¡Œã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚
å•é¡Œã¯ã€ã“ã®ãƒã‚¤ãƒ³ã‚¿ã«ä»–ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒã‚ã‚‹å ´åˆã€ãã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’å¼•ãèµ·ã“ã•ãªã„ã‚ˆã†ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã§ã™ã€‚
ãŸã¨ãˆã°ã€2è¡Œç›®ã§ã€Œä»–ã®å¤‰æ•°ã‚‚åŒã˜å†…å®¹ã‚’æŒã¤ã¹ãã€ã¨è¨€ã£ã¦ã„ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚
ã‚‚ã—æµ…ã„ã‚³ãƒ”ãƒ¼ã‚’è¡Œã£ã¦ã™ã¹ã¦ã®ãƒ“ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã ã‘ã ã¨ã€3è¡Œç›®ã§ã®è¿½åŠ æ“ä½œã«ã‚ˆã£ã¦ã“ã®ãƒã‚¤ãƒ³ã‚¿ãŒç„¡åŠ¹ã«ãªã‚Šã€ã“ã‚ŒãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’å«ã‚€ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ã“ã‚Œã¯éžå¸¸ã«å±é™ºã§ã‚ã‚Šã€éžå¸¸ã«æ‚ªã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã€‚

## æµ…ã„ã‚³ãƒ”ãƒ¼ã€ã‚³ãƒ”ãƒ¼ã€ãƒ ãƒ¼ãƒ–ï¼ˆ2ï¼‰
```nim
var someNumbers = @[1, 2]
var other = someNumbers
someNumbers.add 3 # otherãŒãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã£ã¦ã„ã‚‹
```

- è§£æ±ºç­–1: å…¨ãåŒã˜å†…å®¹ã®æ–°ã—ã„é…åˆ—ã‚’ä½œã‚‹ ("Deep" copy: C++98, ã“ã‚Œã¾ã§ã®Nim)
- è§£æ±ºç­–2: ãƒã‚¤ãƒ³ã‚¿ã¸ã®å‚ç…§ã‚’æŒã¤ãƒã‚¤ãƒ³ã‚¿ã‚’ä½œã‚‹ (å¤šãallocãŒç™ºç”Ÿã—ã€é…ã„)
- è§£æ±ºç­–3: ä»£å…¥ã‚’ç¦æ­¢ã™ã‚‹
- è§£æ±ºç­–4: GCã«ã‚ˆã£ã¦å¤ã„ãƒã‚¤ãƒ³ã‚¿ã‚’æŽƒé™¤ã—ã¦ã‚‚ã‚‰ã†
- è§£æ±ºç­–5: ãƒ¡ãƒ¢ãƒªã‚’"ç›—ã¿"ã€ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã®æ‰€æœ‰æ¨©ï¼‰ã‚’**ç§»å‹•**ã•ã›ã‚‹

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€ã„ãã¤ã‹ã®è§£æ±ºç­–ãŒã‚ã‚Šã¾ã™ã€‚
1ã¤ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®è¦ç´ ã‚’æ·±ãã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯C++ãŒè¡Œã£ã¦ã„ã‚‹ã“ã¨ã§ã‚ã‚Šã€Nimã®ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã§ã‚‚åŒæ§˜ã§ã™ã€‚
åˆ¥ã®è§£æ±ºç­–ã¨ã—ã¦ã¯ã€å…¨å“¡ãŒæ–°ã—ã„æ›´æ–°ã‚’å—ã‘å–ã‚‹ãŸã‚ã«ãƒã‚¤ãƒ³ã‚¿ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã¤ã¨ã„ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯Javaã‚„C#ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ãŒã€ã¯ã‚‹ã‹ã«åŠ´åŠ›ãŒã‹ã‹ã‚Šã€ã‚„ã‚„åŠ¹çŽ‡ãŒæ‚ªããªã‚Šã¾ã™ã€‚
ã•ã‚‰ã«ã€ã“ã‚ŒãŒã€Œæ‚ªã„ä»£å…¥ã€ã§ã‚ã‚‹ã¨ã—ã¦ã€ãã‚Œã‚’ç¦æ­¢ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã²ã©ã„è§£æ±ºç­–ã§ã™ãŒã€å¯èƒ½ã§ã™ã€‚
å‰è¿°ã—ãŸæœ€åˆã®è§£æ±ºç­–ã¨ã—ã¦ã€ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ãŒã“ã®æ‚ªã„ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã‹ã€ä»–ã®å¤‰æ•°ãŒãã‚Œã‚’å‚ç…§ã—ã¦ã„ãªã„å ´åˆã®ã¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã›ã‚‹ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ã¾ãŸã¯ã€æœ€çµ‚çš„ã«ã¯ã“ã‚Œã‚’ã€Œç§»å‹•ã€ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’ç›—ã‚“ã§ãƒ ãƒ¼ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

## æ˜Žç¤ºçš„ãªãƒ ãƒ¼ãƒ–
```nim
var someNumbers = @[1, 2]
var other = move(someNumbers)
# someNumbersã¯ç©ºã«ãªã£ãŸ
someNumbers.add 3

assert someNumbers == @[3]
```
ã“ã‚Œã¯C++ã§ã‚‚åˆ©ç”¨å¯èƒ½ãªæ˜Žç¤ºçš„ãªãƒ ãƒ¼ãƒ–ã§ã€Nimã§ã‚‚åŒæ§˜ã§ã™ã€‚
ã“ã‚Œã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ãªã‚‰ã€ã€Œã“ã®æ•°å€¤ã‚’ã€Žä»–ã€ã«ç§»å‹•ã™ã‚‹ã€ã¨è¨€ãˆã¾ã™ã€‚ãã—ã¦ãã®å¾Œã€ã‚½ãƒ¼ã‚¹ã¯ç„¡åŠ¹ã«ãªã‚Šã€ç©ºã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«ãªã‚Šã¾ã™ã€‚
æ¬¡ã«3ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã“ã‚ŒãŒå”¯ä¸€æ®‹ã‚‹ã‚‚ã®ã§ã™ã€‚6è¡Œç›®ã«è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ãã®å¾Œã€ŒsomeNumbersã€ã«ã¯3ã—ã‹æ®‹ã‚Šã¾ã›ã‚“ã€‚

ã“ã‚ŒãŒæ˜Žç¤ºçš„ãªãƒ ãƒ¼ãƒ–ã§ã™ã€‚ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ã‚ã¾ã‚Šå¿«é©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€æ˜Žç¤ºçš„ã§ã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã¨ãˆã°ã€ŒsomeNumbersã€ãŒãã®å¾Œç©ºã«ãªã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
ã—ã‹ã—ã€æš—é»™çš„ã«ãƒ ãƒ¼ãƒ–ã§ãã‚‹ã‚±ãƒ¼ã‚¹ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚


## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–
```nim
var a = f()
# é–¢æ•°fã®çµæžœã‚’aã«"ç§»å‹•"ã•ã›ã‚‹
```
Rustã§æœ‰åãªæœ€åˆã®ä¾‹ã¨ã—ã¦ã€é–¢æ•°å‘¼ã³å‡ºã—ã®çµæžœã‚’æŒã£ã¦ã„ã‚‹å ´åˆã€ãã‚ŒãŒå¾Œã§ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã§ã€å¤‰æ•°aã«ç›´æŽ¥ãƒ ãƒ¼ãƒ–ã§ãã¾ã™ã€‚

## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–ï¼ˆ2ï¼‰
```nim
var namedValue = g()
var a = f(namedValue) # namedValueã‚’fã«ç§»å‹•ã§ãã‚‹
# fã®çµæžœã‚’aã«ç§»å‹•ã§ãã‚‹
```
1ã¤ã®è¨­è¨ˆç›®æ¨™ã¯ã€ã“ã‚Œã‚’æ©Ÿèƒ½ã•ã›ã‚‹ã“ã¨ã§ã—ãŸã€‚
é–¢æ•°å‘¼ã³å‡ºã—ã¯ãƒ ãƒ¼ãƒ–ã§ãã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã¾ã™ãŒã€å¯èª­æ€§ã‚’æãªã‚ãšã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’ã‹ã‘ãŸãã‚ã‚Šã¾ã›ã‚“ã€‚
"namedValue"ãŒãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§ã‚ã‚‹é™ã‚Šã€Nimã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯"namedValue"ãŒé–¢æ•°å‘¼ã³å‡ºã—ã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ãã®å¾Œã«ã¯ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€"namedValue"ã‚’é–¢æ•°fã«ãƒ ãƒ¼ãƒ–ã—ã€æ¬¡ã«é–¢æ•°fã®çµæžœã‚’"a"ã«ãƒ ãƒ¼ãƒ–ã—ã¾ã™ã€‚

## æš—é»™çš„ãªãƒ ãƒ¼ãƒ–ï¼ˆ3ï¼‰
```nim
var x = @[1, 2, 3]
var y = x # ã¯'x'ã®æœ€å¾Œã®å‘¼ã³å‡ºã—ãªã®ã§ã€'y'ã«ä»£å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
var z = y # ã¯'y'ã®æœ€å¾Œã®å‘¼ã³å‡ºã—ãªã®ã§ã€'z'ã«ä»£å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
```
åˆ¥ã®ä¾‹ã¨ã—ã¦ã€3ã¤ã®æ•´æ•°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚
ãã—ã¦ã€ã€Œy = xã€ã¨è¨€ã£ãŸå ´åˆã€xãŒã‚‚ã†ä½¿ç”¨ã•ã‚Œãªã„ã®ã§ã€ãƒ ãƒ¼ãƒ–ã§ãã¾ã™ã€‚
åŒæ§˜ã«ã€ã€Œy = zã€ã®ä»£å…¥ã§ã‚‚ãƒ ãƒ¼ãƒ–ã§ãã¾ã™ã€‚
ã“ã‚Œã¯ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚

## Sinkå¼•æ•°
```nim
func put(t: var Table; key: string; value: seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ã‚³ãƒ”ãƒ¼ã‚’è¡Œã£ã¦ã„ã‚‹ (Â´ï½¥Ï‰ï½¥`)

var values = @["a", "b", "c"]
tab.put("key", values)
```
æ¬¡ã«ã€é–¢æ•°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã‚ŒãŒå•é¡Œã‚’å¼•ãèµ·ã“ã™ã®ã¯ã€é–¢æ•°ã«æ¸¡ã•ã‚ŒãŸå€¤ãŒå¾Œã§ä½¿ç”¨ã•ã‚Œã‚‹ã‹ã©ã†ã‹ãŒã‚ã‹ã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚
ã“ã®ä¾‹ã§ã¯ã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®Ÿè£…ã®ãŸã‚ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
é€šå¸¸ã¯2è¡Œä»¥ä¸Šã«ãªã‚‹ã§ã—ã‚‡ã†ãŒã€å€¤ã‚’ãƒãƒƒã‚·ãƒ¥ã—ã€ã“ã®ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ ãƒ¼ãƒ–ã—ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
ç¾åœ¨ã®ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã§ã¯ã€ã“ã“ã§ã“ã®é«˜ä¾¡ãªã‚³ãƒ”ãƒ¼æ“ä½œã‚’è¡Œã†ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ2ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
tab.put("key", values) # valueã®æœ€å¾Œã®ä½¿ç”¨ç®‡æ‰€ãªã®ã§ã€ãƒ ãƒ¼ãƒ–ãŒã§ãã‚‹
```
ãŸã ã—ã€ã“ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã«ã€Œsinkã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æ³¨é‡ˆã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãã—ã¦ã€ãã®å¾Œã¯ã‚‚ã†ä½¿ç”¨ã•ã‚Œã‚‹ã¹ãã§ãªã„ã¨ã„ã†åˆ¶ç´„ãŒå‘¼ã³å‡ºã—å…ƒã«ã‚‚å¼·åˆ¶ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€ã€Œsinkã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãŠã‹ã’ã§ã€å¾Œã§ä½¿ç”¨ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã‚Šã€3è¡Œç›®ã§ãƒ ãƒ¼ãƒ–ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
åŒæ§˜ã«ã€3ã¤ã®æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãƒªã‚¹ãƒˆã®å€¤ã‚’æŒã£ã¦ã„ã¦ã€ãã‚Œã‚’å¾Œã§ä½¿ç”¨ã—ãªã„å ´åˆã€ãƒ ãƒ¼ãƒ–ã§ãã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ3ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
tab.put("key", values) # æœ€å¾Œã®å‘¼ã³å‡ºã—ã§ã¯ãªã„ã®ã§ã€ãƒ ãƒ¼ãƒ–ã§ããªã„
echo values

>> Warning: Passing a copy to a sink paramater.
```
ã•ã¦ã€ã‚‚ã—å€¤ã‚’å¾Œã§ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ
ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…éƒ¨ã‚’æ‰€æœ‰ã—ãŸã„ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯è­¦å‘Šã‚’å‡ºã—ã¦ã€ã€Œå¾Œã§ä½¿ç”¨ã•ã‚Œã‚‹ä½•ã‹ã‚’sinkã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€ã¨æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
ã“ã‚Œã‚‚è¨­è¨ˆåŸºæº–ã®1ã¤ã§ã‚ã‚Šã€ã‚‚ã—é–“é•ãˆã¦ã—ã¾ã£ãŸå ´åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¯ä½Žä¸‹ã—ã¾ã™ãŒã€å¥‡å¦™ãªã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®å´é¢ã«ã¤ã„ã¦è­¦å‘Šã—ã¾ã™ã€‚ç¾åœ¨ã€ã“ã®è­¦å‘Šã¯éŽå‰°ã§ã™ã®ã§ã€ã“ã‚Œã‚’ã‚‚ã†å°‘ã—æ”¹å–„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Sinkå¼•æ•°ï¼ˆ4ï¼‰
```nim
func put(t: var Table; key: string; value: sink seq[string]) =
  var h = hash(key)
  t.slots[h] = value # ãƒ ãƒ¼ãƒ–ã™ã‚‹ (Â´âˆ€ï½€*)

var values = @["a", "b", "c"]
echo values
tab.put("key", values)

>> Solution: Move code around.
```
1ã¤ã®è§£æ±ºç­–ã¨ã—ã¦ã¯ã€ã“ã‚Œã‚’ç§»å‹•ã™ã‚‹ã“ã¨ã§ã™ã€‚
ã‚‚ã—ã€ã“ã‚Œã‚’ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åŸ‹ã‚è¾¼ã‚€å‰ã«echoã—ãŸãªã‚‰ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯echoãŒå€¤ã®æ‰€æœ‰æ¨©ã‚’å–ã‚ã†ã¨ã—ã¦ã„ãªã„ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹ã®ã§ã€ã†ã¾ãæ©Ÿèƒ½ã—ã¾ã™ãŒã€ã€Œtable.putã€ã¯ã“ã®ã€Œsinkã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«æ‰€æœ‰æ¨©ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã‚ŒãŒ1ã¤ã®è§£æ±ºç­–ã§ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€ãƒ‡ãƒãƒƒã‚°ç›®çš„ã§ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã ã‘ãªã‚‰ã€ãã‚ŒãŒå¤šãã®ã‚³ãƒ”ãƒ¼ã‚’å¼•ãèµ·ã“ã—ã¦ã‚‚æ°—ã«ã—ãªã„ã§ã—ã‚‡ã†ã€‚ãªãœãªã‚‰ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯å¾Œã§ã™ãã«å‰Šé™¤ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚

## Sinkã®ãã®ä»–ã®ä¾‹
- sinkå¼•æ•°ã¯æœ€é©åŒ–ã®ãŸã‚ã®ã‚‚ã®ã§ã™
- é–“é•ãˆãŸå‘¼ã³å‡ºã—æ–¹ã‚’ã™ã‚‹ã¨ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã«å½±éŸ¿ãŒå‡ºã¾ã™ã€‚
```nim
func `[]=`[K, V](t: var Table[K, V]; k: K, v: V)
func `==`[T](a, b: T):bool
func `+`[T](a, b: T): T
func add[T](s: var seq[T]; v: T)
```
å…ˆã»ã©è¿°ã¹ãŸã‚ˆã†ã«ã€ã€Œsinkã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æœ€é©åŒ–ã§ã™ã€‚ç„¡ç†ã«ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
é–“é•ãˆãŸå ´åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒä»¥å‰ã‚ˆã‚Šæ‚ªããªã‚Šã¾ã™ãŒã€æ­£ã—ãè¡Œã†ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå‘ä¸Šã—ã¾ã™ã€‚
ã¾ãŸã€ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŽ¨æ¸¬ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã‚‚é€²ã‚ã¦ãŠã‚Šã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¨ãä»˜ã‘ãªãã¦ã‚‚æ¸ˆã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¦‹ç›´ã—ã€ã“ã‚Œã‚‰ã®ã€Œsinkã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€ã€Œã„ã‚„ã€ã“ã‚Œã¯ã‚„ã‚‰ãªã„ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«ä»»ã›ã‚ˆã†ã€ã¨æ€ã„ã¾ã—ãŸã€‚

ã¨ã«ã‹ãã€ã“ã“ã§ã„ãã¤ã‹ã®å¥½ããªä¾‹ã‚’æŒ™ã’ã¾ã™ã€‚
ã¾ãšã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã€ã“ã‚ŒãŒã€Œputã€é–¢æ•°ã¾ãŸã¯ã€Œinsertã€ã‚„ã€Œupdateã€ãªã©ã§ã™ã€‚
æ¬¡ã«ã€ã‚¸ã‚§ãƒãƒªãƒƒã‚¯åž‹Tã«å¯¾ã™ã‚‹ç­‰å¼ã‚„Tã«å¯¾ã™ã‚‹ã€Œplusã€ã€æœ€å¾Œã«ã“ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã«å¯¾ã™ã‚‹ã€Œappendã€ã‚„ã€Œaddã€ãŒã‚ã‚Šã¾ã™ã€‚
è³ªå•ã¯ã€ã€Œsinkã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã©ã“ã«ç½®ãã¹ãã‹ã§ã™ã€‚æŽ¨æ¸¬ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ•™ãˆã¾ã™ã€‚

## Sinkã®ãã®ä»–ã®ä¾‹ï¼ˆ2ï¼‰
```nim
func `[]=`[K, V](t: var Table[K, V]; k: sink K, v: sink V)
func `==`[T](a, b: T):bool
func `+`[T](a, b: T): T
func add[T](s: var seq[T]; v: sink T)
```
ã•ã¦ã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä½•ã‹ã‚’åŸ‹ã‚è¾¼ã‚€ã¨ã€Œsinkã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ãã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ã€Œappendã€ã«ã‚‚ã€Œsinkã€ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒä»˜ãã¾ã™ã€‚
æœ€åˆã®è¡Œã¯æŒ¿å…¥ã¾ãŸã¯æ›´æ–°ã§ã™ã€‚
ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ã™ã‚‹å ´åˆã€ã‚­ãƒ¼ã®æ‰€æœ‰æ¨©ã‚‚å–å¾—ã—ãŸã„ã®ã§ã™ãŒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹ã ã‘ãªã‚‰ã€æ—¢ã«ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã‹ã‚‰ã©ã†ãªã‚‹ã‹ã¨ã„ã†ã¨ã€ã“ã‚Œã¯ã€Œsinkã€ã«ãªã‚‹ã¹ãã‹ã©ã†ã‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã¾ã‚ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚ã§ã‚‚ã€ã€Œsinkã€ã‚’ä½¿ã†ã¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã§ã“ã®å€¤ãŒæ¶ˆè²»ã•ã‚Œã‚‹ã“ã¨ã‚’å®Ÿéš›ã«ä¿è¨¼ã—ã¦ãã‚Œã‚‹ã®ã§ã€å¿ƒé…ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã¾ãŸæ¶ˆè²»ã™ã‚‹ã“ã¨ãŒä½•ã‚’æ„å‘³ã™ã‚‹ã‹ã«ã¤ã„ã¦ã®æ¦‚å¿µãŒã‚ã‚Šã¾ã™ã€‚ã¨ã«ã‹ãã€ã“ã‚Œã¯ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«é–¢é€£ã—ã¦ã„ã¾ã™ã®ã§ã€åˆ¥ã®å•é¡Œã§ã™ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨
```nim
func get[K, V](t:Table[K, V]; key: K): V =
  var h = hash(key)
  result = t.slots[h] # ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã‚‹ï¼Ÿ
```
ã•ã¦ã€ã“ã‚Œã§éžå¸¸ã«ç°¡å˜ã«ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚ã®ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã—ã‹ã—ã€ã©ã†ã‚„ã£ã¦å€¤ã‚’å–ã‚Šå‡ºã™ã‹ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€åŒã˜å•é¡ŒãŒç”Ÿã˜ã¾ã™ã€‚ã€Œresult = somethingã€ã®ä»£å…¥ã¯returnæ–‡ã¨åŒã˜ã§ã™ãŒã€ã“ã‚ŒãŒå†åº¦é«˜ä¾¡ãªã‚³ãƒ”ãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’ã‚ˆã‚Šæ˜Žç¢ºã«ã™ã‚‹ãŸã‚ã«ä»£å…¥ã¨ã—ã¦æ›¸ãã¾ã—ãŸã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ2ï¼‰
```nim
func get[K, V](t:Table[K, V]; key: K): V =
  var h = hash(key)
  result = move(t.slots[h]) # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
```
ã•ã¦ã€ã“ã‚Œã‚’ãƒ ãƒ¼ãƒ–ã—ã‚ˆã†ã¨è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ã€Œtã€ãŒå®Ÿéš›ã«ã¯ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§ãªã„ãŸã‚ã€ãƒ ãƒ¼ãƒ–ã§ããªã„ã¨æ–‡å¥ã‚’è¨€ã„ã¾ã™ã€‚ãªãœãªã‚‰ã€ãƒ ãƒ¼ãƒ–ã¯ã‚½ãƒ¼ã‚¹ã‚’å¤‰ç•°ã•ã›ã‚‹ã‹ã‚‰ã§ã™ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ3ï¼‰
```nim
func get[K, V](t:var Table[K, V]; key: K): V =
  var h = hash(key)
  result = move(t.slots[h]) # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ãŒã€ã‹ãªã‚Šå±é™º
```
ã§ã¯ã€ã“ã‚Œã‚’ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã“ã‚Œã§æ©Ÿèƒ½ã—ã¾ã™ãŒã€ä»Šåº¦ã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã“ã®å€¤ã‚’ãƒ ãƒ¼ãƒ–ã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä¸€åº¦ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€ãã®å¾Œã¯æ¶ˆãˆã¾ã™ã€‚
ã“ã‚Œã¯éžå¸¸ã«ä¸ä¾¿ã§ã™ãŒã€ã‚‚ã—ã€Œpopã€æ“ä½œã‚’æŒã¤ã‚¹ã‚¿ãƒƒã‚¯ãŒã‚ã‚Œã°ã€ãã‚ŒãŒã¾ã•ã«æ±‚ã‚ã¦ã„ã‚‹ã“ã¨ã§ã™ãŒã€ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¨ã£ã¦ã¯éžå¸¸ã«ä¸ä¾¿ã§ã™ã€‚

## ã‚²ãƒƒã‚¿ãƒ¼ï¼šå€¤ã®å€Ÿç”¨ï¼ˆ4ï¼‰
```nim
func get[K, V](t: Table[K, V]; key: K): lent V =
  var h = hash(key)
  result = t.slots[h] # ã‚³ãƒ”ãƒ¼ã§ã‚‚ãƒ ãƒ¼ãƒ–ã§ã‚‚ãªãã€"å€Ÿç”¨"
```
ã“ã“ã§ã€åˆ¥ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãã‚ŒãŒã€Œlent Vã€ã§ã‚ã‚Šã€ã“ã‚Œã¯å€Ÿç”¨æ“ä½œã«ãªã‚Šã¾ã™ã€‚
Rustã§ã¯ã€ã“ã‚ŒãŒå€Ÿç”¨ãƒã‚¤ãƒ³ã‚¿ã«ç›¸å½“ã—ã€C++ã§ã¯ã€Œrefã€ã¨å‘¼ã°ã‚Œã¾ã™ã€‚å®Ÿéš›ã«ã¯åŒã˜ã“ã¨ã§ã™ã€‚
å€Ÿç”¨ã—ãŸå¾Œã€ãã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å¯¿å‘½ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã•ã¦ã€ãƒã‚¤ãƒ³ãƒˆã¯ã€Rustã§ã¯ã“ã‚ŒãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã€C++ã§ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ãã—ã¦Nimã§ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ãŒã€ã¾ã æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚

## å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ
- ã“ã‚Œã¾ã§ã©ã®ã‚ˆã†ã«æœ€é©åŒ–ãŒå½ã®ã‚³ãƒ”ãƒ¼ã‚’å–ã‚Šé™¤ãã‹ã‚’è¦‹ã¦ãã¾ã—ãŸ
- åŒã˜åŽŸç†ãŒå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ(=RC)ã«ã‚‚é©ç”¨ã•ã‚Œã¾ã™
- å‚ç…§ã®ã‚³ãƒ”ãƒ¼ â†’ incRc(src); decRc(dest); dest = src
- å‚ç…§ã®ç§»å‹• â†’ dest = src
- ã“ã‚ŒãŒ`--gc:arc`ãƒ¢ãƒ¼ãƒ‰ã®é–‹ç™ºã«ã¤ãªãŒã‚Šã¾ã—ãŸ

ä»Šã€è¤‡é›‘ãªä»£å…¥ï¼ˆãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã‚„ãã®ä»–ã®ã‚‚ã®ï¼‰ã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•ã‚’ç†è§£ã—ãŸã®ã§ã€ã“ã®çŸ¥è­˜ã‚’ä»–ã®ã“ã¨ã«å¿œç”¨ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚
å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã¯ã€ãƒã‚¤ãƒ³ã‚¿ã®ä»£å…¥ãŒä»¥å‰ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«é«˜ä¾¡ã«ãªã£ãŸã ã‘ã§ã‚ã‚Šã€ãƒã‚¤ãƒ³ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹éš›ã«ã€ã‚½ãƒ¼ã‚¹ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã€ãƒ‡ã‚£ã‚¹ãƒ†ã‚£ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ‡ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã€ãã®å¾Œã§ãƒã‚¤ãƒ³ã‚¿ã‚³ãƒ”ãƒ¼ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—ã€**ãƒã‚¤ãƒ³ã‚¿ã‚’ãƒ ãƒ¼ãƒ–ã§ãã‚‹å ´åˆ**ã€ãã‚Œã¯å˜ã«ã“ã®ãƒ“ãƒƒãƒˆå˜ä½ã®ã‚³ãƒ”ãƒ¼ã§ã‚ã‚Šã€å¿…è¦ã«å¿œã˜ã¦ã‚½ãƒ¼ã‚¹ã‚’nilã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®æ´žå¯Ÿã«ã‚ˆã‚Šã€æ–°ã—ã„ã‚¬ãƒ¼ãƒ™ãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®é–‹ç™ºãŒé€²ã¿ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ŒGCã€ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ãŒã€GCã¯å®Ÿéš›ã«ã¯Nimã®åå‰ã§ã€ã‚ãªãŸãŒæœ›ã‚€ã‚ã‚‰ã‚†ã‚‹ç¨®é¡žã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’æ„å‘³ã—ã¾ã™ã€‚

## ARC
```nim
include prelude

type
  Node = ref object
    le, ri: Node

proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(depth: int): Node =
  if depth == 0: Node(le: nil, ri: nil)
  else: Node(le: makeTree(depth-1), ri: makeTree(depth-1))
```
ã“ã“ã«ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ãƒã‚¤ãƒŠãƒªãƒ„ãƒªãƒ¼ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã‚ã‚Šã€ã‚¬ãƒ¼ãƒ™ãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®ãŸã‚ã®æ¨™æº–çš„ãªãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã™ã€‚
ã“ã®ã™ã¹ã¦ã‚’ç†è§£ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒã‚¤ãƒ³ãƒˆã¯ã€ã“ã“ã§ **ã€Œsinkã€ã‚„ã€Œlendã€ãªã©ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„** ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ã“ã‚Œã‚‰ãŒå†…éƒ¨ã§æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ä½•å…†ã‚‚ã®ãƒã‚¤ãƒŠãƒªãƒ„ãƒªãƒ¼ã‚’ã‚ã‚‹æ·±ã•ã¾ã§ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## ARC(2)
```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  echo("stretch tree of depth ", stretchDepth, "\t check: ", checkTree(makeTree(stretchDepth)))
  let longLivedTree = makeTree(maxDepth)
  var iterations = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterations:
      check += checkTree(makeTree(depth))
    echo iterations, "\t trees of depth ", depth
    iterations = iterations div 4

main()
```
ã“ã‚ŒãŒä¸»è¦ãªéƒ¨åˆ†ã§ã™ã€‚å…ˆã»ã©è¿°ã¹ãŸã‚ˆã†ã«ã€ã“ã‚Œã¯æ¨™æº–çš„ãªãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã‚ã‚Šã€çµæžœã¯æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„ã‚‚ã®ã§ã™ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|**6.75s**|472.098MiB|

Nimã§ã¯ã„ãã¤ã‚‚ã®ã‚¬ãƒ¼ãƒ™ãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æŒã£ã¦ã„ã¦ã€ã™ã¹ã¦ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚
ãã—ã¦ã€æ–°ã—ã„ã‚‚ã®ã¯éžå¸¸ã«é€Ÿã„ã‚‚ã®ã§ã€3å€ã‚„2å€ãªã©ã€ã©ã®ã‚ˆã†ã«æ¯”è¼ƒã™ã‚‹ã‹ã«ã‚‚ã‚ˆã‚Šã¾ã™ãŒã€å¤§å¹…ã«é€Ÿã„ã§ã™ã€‚
ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã¯ã€ŒboehmGCã€ã¨ã»ã¼åŒã˜ã§ã™ã€‚ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’æ­£ç¢ºã«æŠŠæ¡ã™ã‚‹ã“ã¨ã¯ã§ãã¦ã„ãªã„ã®ã§ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã€‚
ã“ã‚Œã¯ä»¥å‰ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«å„ªã‚Œã¦ã„ã¾ã™ã€‚

## æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†
```nim
include prelude

type
  Node = ptr object
    le, ri: Node

proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(depth: int): Node =
  result = cast[Node](alloc(sizeof(result[]))) # 12è¡Œç›®
  if depth == 0:
    result.le = nil; result.ri = nil
  else:
    result.le = makeTree(depth-1)
    result.ri = makeTree(depth-1)

proc freeTree(n: Node) =
  if n != nil:
    freeTree(n.le); freeTree(n.ri); dealloc(n)
```
ã•ã¦ã€æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ã¨æ¯”è¼ƒã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
Nimã¯ä¸¡æ–¹ã‚’è¡Œã†ã“ã¨ãŒã§ãã€ç‹¬è‡ªã®ãƒã‚¤ãƒ³ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ä»¥å‰ã¯4è¡Œç›®ã«ã€Œrefã€ãŒã‚ã‚Šã¾ã—ãŸãŒã€ä»Šã§ã¯ã€Œptrã€ã§ã™ã€‚ãƒ„ãƒªãƒ¼ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€12è¡Œç›®ã§ã“ã®ã‚­ãƒ£ã‚¹ãƒˆã‚’ä½¿ã£ã¦åŽ„ä»‹ãªã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã€ã‚‚ã¡ã‚ã‚“ã€ãƒ„ãƒªãƒ¼ã‚’æ‰‹å‹•ã§è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯å†å¸°çš„ãªè§£æ”¾ã§ã‚ã‚Šã€æœ€åˆã«å·¦ã€æ¬¡ã«å³ã‚’è§£æ”¾ã—ã€ãã®å¾Œã€ã“ã®ãƒŽãƒ¼ãƒ‰ã‚’è§£æ”¾ã—ã¾ã™ã€‚

## æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼ˆ2ï¼‰

```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  let stree = makeTree(stretchDepth)
  echo("stretch tree of depth ", stretchDepth, "\t check:",
    checkTree(stree))
  let longLivedTree = makeTree(maxDepth)
  var iterations = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterations:
      let tmp = makeTree(depth)
      check += checkTree(makeTree(tmp))
      freeTree(tmp) # 15è¡Œç›®
    echo iterations, "\t trees of depth ", depth
    iterations = iterations div 4
  freeTree(longLivedTree); freeTree(stree) # 18è¡Œç›®

main()
```
ä»Šã€mainé–¢æ•°ã§ã¯ã€ã“ã‚Œã‚‰ã®ãƒ„ãƒªãƒ¼ã‚’æ‰‹å‹•ã§è§£æ”¾ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€éžå¸¸ã«é¢å€’ã§ã™ã€‚ä¾‹ãˆã°18è¡Œç›®ã‚„ã€å¾Œã§è§£æ”¾ã™ã‚‹ãŸã‚ã«æ–°ã—ã„ä¸€æ™‚å¤‰æ•°ã‚’å°Žå…¥ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸ15è¡Œç›®ã§ã“ã‚Œã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|**6.75s**|472.098MiB(379.074MiB)|
|manual|5.23s|244.563MiB|
|manual(with RC)|6.244s|379.074MiB|

çµæžœã¯ã€ãã‚Œã§ã‚‚ã¾ã é…ã„ã§ã™ã€‚æ®‹å¿µã§ã™ã€‚
ã—ã‹ã—ã€ã“ã“ã§é‡è¦ãªã®ã¯ã€ARCãŒå®Ÿéš›ã«è¡Œã†ã“ã¨ã¯å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã®æœ€é©åŒ–ã§ã‚ã‚Šã€æ‰‹å‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¡Œã†ã“ã¨ã¯åŸºæœ¬çš„ã«å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒãŸãªã„ã“ã¨ã§ã™ã€‚ãªãœãªã‚‰ã€ã“ã‚Œã‚‰ãŒä¸€æ„ã®ãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚
ã“ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚’ã“ã®æ‰‹å‹•ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ãŸã‚ã«ãƒžã‚·ãƒ³ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã¨ã€å†ã³ã»ã¼åŒã˜ã«ãªã‚Šã€6.2ç§’ã«æˆ»ã‚Šã¾ã™ãŒã€ARCã¯6.7ç§’ã§ã™ã€‚
æ®‹ã‚Šã®ãƒã‚°ã‚’ä¿®æ­£ã—ãŸå ´åˆã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã¯åŒã˜ã§ã™ã€‚
æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ãŒã€ã“ã®ç‰¹å®šã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã¯ã€é•ã„ãŒãƒŽã‚¤ã‚ºãƒ¬ãƒ™ãƒ«ã«é”ã™ã‚‹ã¾ã§è¿‘ã¥ã‘ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ã¾ã ãã“ã¾ã§ã¯é”ã—ã¦ã„ã¾ã›ã‚“ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
|Memory management strategy|Latency|Total Time|Peak Memory|
|---|---|---|---|
|defferd refcountng GC|0.0356ms|0.314s|300MiB|
|ARC|0.0106ms|0.254s|271MiB|

ã•ã¦ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã®ãŸã‚ã®åˆ¥ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã™ãŒã€ãã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã—ã‹ã—ã€ä»¥å‰ã¯ã‚½ãƒ•ãƒˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®ã‚¬ãƒ¼ãƒ™ãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æŒã£ã¦ã„ã¦ã€ã“ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒ0.03ãƒŸãƒªç§’ã§ã—ãŸã€‚
ç¾åœ¨ã€ARCã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãã‚ŒãŒ3å€ä»¥ä¸Šæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚å…¨ä½“ã®å®Ÿè¡Œæ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã€ãƒ”ãƒ¼ã‚¯ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚‚æ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚ã—ãŸãŒã£ã¦ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã ã‘ã§ãªãã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚‚æ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒŠ
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã€ä»£å…¥ã¨ç§»å‹•ã®æœ€é©åŒ–
- ãƒ•ã‚¡ã‚¤ãƒ«/ã‚½ã‚±ãƒƒãƒˆãªã©ã‚’è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã§ãã‚‹ï¼ˆC++ã‚„Rustã®ã‚ˆã†ã«ï¼‰
- ç‰¹æ®Šãªãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã‚’åˆä½“ã§ãã‚‹

ã™ã§ã«æ¦‚èª¬ã—ãŸã‚ˆã†ã«ã€å†…éƒ¨ã§ã¯ã€ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚„ãƒ ãƒ¼ãƒ–æ¼”ç®—å­ã€ä»£å…¥ãŒã‚ã‚Šã€ãã‚Œã‚‰ã‚’ä»–ã®ã“ã¨ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã‚‰ã¯ã‚ãªãŸã«å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚å°‘ã—å¾Œã§è¦‹ã¦ã¿ã¾ã™ãŒã€ä»Šã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½¿ç”¨å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯éžå¸¸ã«ä¾¿åˆ©ã§ã€ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã‚Œã‚‰ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ãƒŠé–“ã§ã®æ§‹æˆãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚
ä»¥å‰ã¯ã€æ‰‹å‹•ãƒ¡ãƒ¢ãƒªç®¡ç†ã¨GCãƒ¡ãƒ¢ãƒªç®¡ç†ãŒã‚ã‚Šã€æ··ãœã¦ã¯ã„ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãªãœãªã‚‰ã€ã†ã¾ãæ©Ÿèƒ½ã—ãªã„ã‹ã‚‰ã§ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã‚‰ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã“ã‚Œã‚‰2ã¤ã®ä¸–ç•Œã®é–“ã®ç›¸äº’ä½œç”¨ãŒä»¥å‰ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«
```nim
include prelude

type
  NodeObj = object
    le, ri: Node
  Node = ptr NodeObj

  PoolNode = object
    next: ptr PoolNode
    elems: UncheckedArray[NodeObj]

  Pool = object
    len: int
    last: ptr PoolNode
    lastCap: int
```

ã“ã“ã§ã€ä»Šã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‚ã†1ã¤ã®ã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚åŒã˜ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã§ã™ãŒã€ä»Šåº¦ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’æŒã¡ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚Œã‚’ã€Œã‚¢ãƒªãƒ¼ãƒŠã€ã¨å‘¼ã¶æ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚
ã‚¢ãƒªãƒ¼ãƒŠã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ãŒã‚ã‚Šã€ã“ã‚Œã‚‰ã®ãƒŽãƒ¼ãƒ‰ã‚’æ‰±ã„ç¶šã‘ã¾ã™ãŒã€ã“ã‚Œã«ã¯2ã¤ã®ãƒã‚¤ãƒ³ã‚¿ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

â€»è¨³è€…æ³¨ï¼š
C++ã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã«ã€ŒArena Allocationã€ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã€ã“ã‚Œã¯Nimã§ã®å®Ÿè£…ã§ã‚ã‚‹ã€‚

> Project Snowflake ã«ä»£ã‚ã£ã¦1ã¤æœ‰æœ›è¦–ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€ Arena Allocation ã¨ã„ã†æ‰‹æ³•ã§ã™ã€‚
> [Protocol Buffersã® C++ ç‰ˆ](https://developers.google.com/protocol-buffers/docs/reference/arenas)ãŒã“ã®æ‰‹æ³•ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’æä¾›ã—ã¦ã„ã‚‹ã‚“ã§ã™ãŒã€ãã‚Œã‚’ .NET ã«ã‚‚å°Žå…¥ã§ããªã„ã‹ã¨ã„ã†èª¿æŸ»ã‚’ã—ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚ ã¾ã ã‚ã‚“ã¾ã‚Šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªãã€QConSFã®ç™»å£‡ã§è»½ãç´¹ä»‹ã•ã‚ŒãŸç¨‹åº¦ã§ã™ãŒã€‚
> [CLR/CoreCLR: How We Got Here & Where We're Going](https://qconsf.com/sf2018/presentation/clrcoreclr-how-we-got-here-where-were-going)
> ã“ã‚Œã‚‚ã€ã€Œã‚ã‚‹ç¨‹åº¦ã¾ã¨ã¾ã£ãŸå˜ä½ã§ã”ã£ãã‚Šå‡¦ç†ã™ã‚‹æ–¹ãŒé«˜åŠ¹çŽ‡ã€ã¨ã„ã†åŽŸç†ã«å‰‡ã£ãŸã‚‚ã®ã§ã™ã€‚ ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ã€Œã”ã£ãã‚Šæ¶ˆã™ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜Žç¤ºã™ã‚‹ã‚ˆã†ãªæ–¹å¼ã€‚ ãƒ¡ãƒ¢ãƒªæ”¾æ£„ã®ã¾ã¨ã¾ã£ãŸå˜ä½ã‚’æŒ‡ã—ã¦ arena (èˆžå°ã€ç«¶æŠ€å ´ã€ç•Œ)ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚

å¼•ç”¨å…ƒï¼šhttps://ufcpp.net/blog/2018/12/futurememorymanagement/


## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ2ï¼‰
```nim
proc newNode(p: var Pool): Node =
  if p.len >= p.lastCap:
    if p.lastCap == 0: p.lastCap = 4
    elif p.lastCap < 65_000: p.lastCap *= 2
    var n = cast[ptr PoolNode](alloc(sizeof(PoolNode) *
      p.lastCap * sizeof(NodeObj)))
    n.next = nil
    n.next = p.last
    p.last = n
    p.len = 0
  result = addr(p.last.elems[p.len])
  p.len += 1
```
æ–°ã—ã„ãƒŽãƒ¼ãƒ‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã«ã¯ã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ã‚ˆã†ã«ã€å®¹é‡ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åŸºæœ¬çš„ã«ç¢ºèªã—ã¾ã™ã€‚
ãƒŽãƒ¼ãƒ‰è‡ªä½“ã¯ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚Šã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹é…åˆ—ã®è¦ç´ ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ3ï¼‰
```nim
proc `=`(dest: var Pool; src: Pool) {.error.}

proc `=destroy`(p: var Pool) =
  var it = p.last
  while it != nil:
    let next  = it.next
    dealloc(it)
    it = next
  p.len = 0
  p.lastCap = 0
  p.last = nil
```

ã“ã“ã§ãƒ—ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã„å ´åˆã€ã€Œã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã€ã¨è¨€ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãªãœãªã‚‰ã€å®Ÿè£…ã™ã‚‹ã®ãŒé¢å€’ã ã£ãŸã‹ã‚‰ã§ã™ã€‚
ã—ãŸãŒã£ã¦ã€ãƒ—ãƒ¼ãƒ«ã‚’èª¤ã£ã¦ã‚³ãƒ”ãƒ¼ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒã€Œã§ãã¾ã›ã‚“ã€ã¨æ•™ãˆã¦ãã‚Œã¾ã™ã€‚
ãƒ—ãƒ¼ãƒ«ãŒã‚¹ã‚³ãƒ¼ãƒ—å¤–ã«ãªã‚‹ã¨ã€93è¡Œç›®ã«è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
å½“ç„¶ã®ã“ã¨ãªãŒã‚‰ã€ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ä½•ã‚’ã™ã‚‹ã‹ã¨ã„ã†ã¨ã€ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆã‚’ä»‹ã—ã¦ãƒã‚§ãƒ¼ãƒ³ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾ã—ã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ4ï¼‰
```nim
proc checkTree(n: Node): int =
  if n.le == nil: 1
  else: 1 + checkTree(n.le) + checkTree(n.ri)

proc makeTree(p:var Pool; depth: int): Node =
  result = newNode(p)
  if depth == 0:
    result.le = nil
    result.ri = nil
  else:
    result.le = makeTree(p, depth-1) # 11è¡Œç›®
    result.ri = makeTree(p, depth-1) # 12è¡Œç›®
```
æ®‹å¿µãªãŒã‚‰ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ„ãƒªãƒ¼ã‚’ä½œæˆã—ãŸã„å ´åˆã¯ã€ã“ã®ãƒ—ãƒ¼ãƒ«ãŒæ–°ã—ã„ãƒŽãƒ¼ãƒ‰ã‚’ã©ã“ã‹ã‚‰å–å¾—ã™ã‚‹ã‹ã‚’èªè­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€ã“ã‚ŒãŒã€ŒmakeTreeã€ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãªã‚Šã€å†å¸°çš„ã«11è¡Œç›®ã¨12è¡Œç›®ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ï¼ˆ5ï¼‰
```nim
proc main =
  let maxDepth = parseInt(paramStr(1))
  const minDepth = 4
  let stretchDepth = maxDepth + 1
  var longLived: Pool # 5è¡Œç›®
  let stree = makeTree(longLived, maxDepth)
  echo("stretch tree of depth ", stretchDepth, "\t check ",
    checkTree(stree))
  let longLivedTree = makeTree(longLived, maxDepth)
  var iterators = 1 shl maxDepth
  for depth in countup(minDepth, maxDepth, 2):
    var check = 0
    for i in 1..iterators:
      var shortLived: Pool # 14è¡Œç›®
      check += checkTree(makeTree(shortLived, depth))
    echo iterators, "\t trees of depth ", depth
    iterators = iterators div 4

main()
```

ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿã•ã¦ã€è‡ªå‹•çš„ã«ãƒ—ãƒ¼ãƒ«ãŒè§£æ”¾ã•ã‚Œã‚‹ã®ã§ã€ä½¿ç”¨ãŒå°‘ã—ç°¡å˜ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã®å ´åˆã€é•·å¯¿å‘½ãƒ‡ãƒ¼ã‚¿ç”¨(longLived)ã¨çŸ­å‘½ãƒ‡ãƒ¼ã‚¿ç”¨(shortLived)ã«2ã¤ã®ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯5è¡Œç›®ã¨14è¡Œç›®ã«è¦‹ã‚‰ã‚Œã¾ã™ã€‚

## ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ï¼šå‡¦ç†èƒ½åŠ›
|Memory management strategy|Time|Peak Memory|
|---|---|---|
|mark&sweep GC|17s|588.047MiB|
|deferred refcounting GC|16s|304.074MiB|
|Boehm GC|12s|N/A|
|ARC|6.75s|472.098MiB(379.074MiB)|
|manual|5.23s|244.563MiB|
|manual(with RC)|6.244s|379.074MiB|
|object pooling|**2.4s**|251.504MiB|

ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿçµæžœã¯ã¯ã‚‹ã‹ã«é€Ÿãã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒ2å€ä»¥ä¸Šå‘ä¸Šã—ã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚‚ã»ã¼åŒã˜ã§ã™ã€‚

## ã¾ã¨ã‚

- æ‰€æœ‰æ¨©ã®ç§»å‹•ã¯é–‹ç™ºè€…ã«ã¯è¦‹ãˆãªã„ã¨ã“ã‚ã§å‹•ãã¾ã™
- `sink` ã¨ `lent` ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ä»»æ„ã§ã™
- ä¿¡ã˜ã‚‰ã‚Œãªã„ã»ã©ã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ”¹è‰¯ã«ã¤ãªãŒã‚Šã¾ã™
- Nim ã‚’ã‚ˆã‚Šé€Ÿãã€"æ±ºå®šè«–çš„"ã«ã—ã¾ã™
- æ–°ã—ã„æˆ¦ç•¥ãŒä»¥ä¸‹ã‚’æ”¹å–„ã—ã¾ã™
  - å‡¦ç†é€Ÿåº¦
  - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
  - ãƒ¡ãƒ¢ãƒªæ¶ˆè²»
  - ã‚¹ãƒ¬ãƒƒãƒ‰
  - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å®¹æ˜“ã•
  - æŸ”è»Ÿãªæ§‹æˆ

ã•ã¦ã€ã¾ã¨ã‚ã‚‹ã¨ã€ãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã¯ä¸»ã«å†…éƒ¨ã§æ©Ÿèƒ½ã—ã¦ãŠã‚Šã€æœ¬å½“ã«å„ªã‚ŒãŸæœ€é©åŒ–ã‚’æä¾›ã—ã¦ãã‚Œã¾ã™ã€‚
ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã‚’è¦‹ã¦ãã¾ã—ãŸã—ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ãŒæ±ºå®šè«–çš„ã«ãªã‚Šã¾ã™ã€‚
ã“ã“ã§ã®å®Ÿéš›ã®çŠ¶æ³ã¯ã€å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆæ–¹å¼ã‚’ä½¿ç”¨ã—ã¦ãã‚Œã‚’æœ€é©åŒ–ã™ã‚‹ã¨ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã«ã‚³ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’æ·»ä»˜ã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ãã‚Œã‚’è¡Œã†ã¨ã€Nimã‚’ä½¿ã£ã¦ãƒãƒ¼ãƒ‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ ã«ç§»è¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã€ãŠã‚ˆã³ã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç†ãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚
ä¾‹ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰åˆ¥ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç§»å‹•ã§ãã‚‹ã¨ã€ãã‚ŒãŒã“ã®ãƒ‡ãƒ¼ã‚¿ã®æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ã‚¹ãŒç™ºç”Ÿã—ãªã„ã“ã¨ãŒæƒ³åƒã§ãã¾ã™ã€‚ãã‚Œã¯éžå¸¸ã«ä¾¿åˆ©ãªæ©Ÿèƒ½ã§ã™ã€‚

ã¾ãŸã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®å®¹æ˜“ã•ã‚‚å‘ä¸Šã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«é–‰ã˜ã‚‰ã‚Œã€ã‚½ã‚±ãƒƒãƒˆã‚‚åŒæ§˜ã§ã™ã€‚
ã¾ãŸã€ã“ã‚Œã‚‰ã®ç•°ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¯ãƒ©ã‚¹é–“ã®æ§‹æˆãŒæ”¹å–„ã•ã‚Œã¾ã™ã€‚

## Happy hacking!ãƒ¼ãƒãƒƒã‚¯ã‚’æ¥½ã—ã‚‚ã†ï¼
ã“ã‚Œã‚‰ã®ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚
ã™ã§ã«ã”å­˜ã˜ã§ãªã„å ´åˆã¯ã€ç§ãŸã¡ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚„ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ã€ãã—ã¦IRCã«ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚
ã§ã¯ã€ç§ã®è¬›æ¼”ã¯ã“ã‚Œã§çµ‚ã‚ã‚Šã§ã™ã€‚ã”æ¸…è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

https://github.com/Araq/fosdem2020

|||
|---|---|
|Website|https://nim-lang.org/|
|Forum|https://forum.nim-lang.org/|
|Github|https://github.com/nim-lang/Nim|
|IRC|https://webchat.freenode.net/?channels=nim|

## è¨³è€…ã‚ã¨ãŒã
ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚ã“ã‚ŒãŒNimä½œè€…ã§ã‚ã‚‹AraqãŒæ±‚ã‚ã‚‹Nimã§ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã§ã™ã€‚
ã“ã®è¬›æ¼”ãŒè¡Œã‚ã‚ŒãŸ2020å¹´2æœˆ5æ—¥å½“æ™‚ã§ã¯ã¾ã ã“ã“ã§æŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ARCã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã§ã—ãŸãŒã€ãã®å¾Œ2020å¹´4æœˆ3æ—¥ã®v1.2ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã‚µãƒãƒ¼ãƒˆã•ã‚Œã€2020å¹´10æœˆ16æ—¥ã®v1.4ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã¯ARCã‚’æ›´ã«å¾ªç’°å‚ç…§ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã—ãŸORCã¨ã„ã†ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚Araqã¯Nimã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒ¢ãƒªç®¡ç†æ‰‹æ³•ã‚’å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰ORCã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€æ—¥ã€…ç ”ç©¶ã‚’ç¶šã‘ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

Nimã§ã¯Rustã®æ‰€æœ‰æ¨©ãƒ¢ãƒ‡ãƒ«ã‚„C++ã®ã‚¹ãƒžãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã‚’ç”¨ã„ãŸãƒ ãƒ¼ãƒ–ã‚»ãƒžãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãªã©å‚è€ƒã«ã—ã¦ã€é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒç™ºæ®ã§ãã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã¨ãªã£ã¦ã„ã¾ã™ã€‚
`sink`ã‚„`lent`ã¨è¨€ã£ãŸã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼•æ•°ã«å¯¾ã—ã¦ä½¿ã„ã€Rustã¨åŒã˜ãƒ¢ãƒ‡ãƒ«ã§æ‰€æœ‰æ¨©ã«åŸºã¥ããƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ã™ã‚Œã°ã€é€šå¸¸ã®å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚ˆã‚Šã‚‚å¤§å¹…ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå‘ä¸Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
Nimã§ã¯ãã‚Œã‚’æ›´ã«é€²ã‚ã¦ã€ARCãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚Œã°ã€æ‰€æœ‰æ¨©ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦é–‹ç™ºè€…ãŒæ°—ã«ã—ã¦`sink`ã‚„`lent`ã®ã‚¢ãƒŽãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒãªãã€åŒã˜ã ã‘ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’å®Ÿç¾ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

æ›´ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã†ã“ã¨ã§ARCã‹ã‚‰3å€ã®åŠ¹çŽ‡åŒ–ãŒã§ãã¾ã™ã€‚ã“ã¡ã‚‰ã¯æ˜Žç¤ºçš„ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒå¿…è¦ã§ã™ãŒã€ç‰¹ã«ãƒãƒ¼ãƒ‰ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ å‘ã‘ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’èª­ã‚“ã èª­è€…ã®ä¸­ã‹ã‚‰ä¸€äººã§ã‚‚å¤šãNimã‚’ä½¿ã£ãŸé–‹ç™ºã‚’å§‹ã‚ã¦ãã‚Œã‚‹ã“ã¨ã‚’å¿ƒã‹ã‚‰é¡˜ã£ã¦ã„ã¾ã™ã€‚
