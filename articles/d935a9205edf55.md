---
title: "Nimã§JavaScriptã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é–‹ç™ºã‚’ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ‘‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nim", "javascript"]
published: false
---

Nimã§ã¯Cè¨€èªã«ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã—ã¦å®Ÿè¡Œå¯èƒ½ãƒã‚¤ãƒŠãƒªã‚’ä½œã‚‹ä»¥å¤–ã«ã‚‚JavaScriptã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ã“ã‚ŒãŒéå¸¸ã«ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒå¿…è¦ãªã®ã§ä»Šå›ã¯ã‚ã‹ã‚Šã‚„ã™ãç¶²ç¾…çš„ã«è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
å®Ÿéš›ã«é–‹ç™ºã—ã¦ã¿ãŸæ„Ÿæƒ³ã¨ã—ã¦ã¯ã€Nimã‚’JSã«é™çš„ãªå‹ã‚’ä»˜ã‘ã‚‹ãŸã‚ã®ã‚‚ã®ã¨è€ƒãˆã‚‹ã¨ã€æ„å¤–ã¨è‰¯ã„ãªã¨ã„ã†æ„Ÿã˜ã¯ã—ã¾ã—ãŸã€‚

## JSã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®åŸºç¤
### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
https://nim-lang.org/docs/backends.html#backends-the-javascript-target

```nim:js_sample.nim
echo "hoge"
```

```sh:ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
nim js js_sample.nim
```

`nim js`ã‚³ãƒãƒ³ãƒ‰ã§`js_sample.js`ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
ã‚‚ã—å®Ÿè¡Œç’°å¢ƒã«NodeJSãŒå…¥ã£ã¦ã„ã‚Œã°ã€ãã®ã¾ã¾å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```sh:ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
nim js -r js_sample.nim
```
```sh:å‡ºåŠ›
hoge
```

### æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
JavaScriptå‘ã‘ã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã€ä¾¿åˆ©ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

|lib|èª¬æ˜|
|---|---|
|[asyncjs](https://nim-lang.org/docs/asyncjs.html)|JSã®éåŒæœŸå‡¦ç†ã®async/awaitã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚Nimã®`Future[T]`ãŒJSã®`Promise<T>`ã«ãªã‚Šã¾ã™ã€‚|
|[dom](https://nim-lang.org/docs/dom.html)|ãƒ–ãƒ©ã‚¦ã‚¶ãŒæŒã£ã¦ã„ã‚‹`document`ã‚„`window`ãªã©DOMæ“ä½œã‚’ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚|
|[jsbigints ](https://nim-lang.org/docs/jsbigints.html)|JSã®BitIntå‹ã‚’æ‰±ã„ã¾ã™ã€‚|
|[jsconsole](https://nim-lang.org/docs/jsconsole.html)|`conoel.log()`ãªã©ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚|
|[jscore](https://nim-lang.org/docs/jscore.html)|JSã®`Math`ã€`JSON`ã€`Date`ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æä¾›ã—ã¾ã™ãŒæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ãŸã»ã†ãŒå®‰å…¨ã§ã™ã€‚|
|[jsffi](https://nim-lang.org/docs/jsffi.html)|Nimã¨JSã®é–“ã§å‹ã‚’ç›¸äº’ã«å¤‰æ›ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚|

### å‹ã®æ‰±ã„
Nimã®å‹ã¯JSã«å‡ºåŠ›ã•ã‚Œã‚‹ã¨ã©ã†ãªã‚‹ã‹è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```nim:app.nim
import std/jsffi
import std/times

let i = 0
let j = 0.0
let str = "string"
let cstr:cstring = "cstring"
let data = now()
```
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨JSãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```js:app.js
function makeNimstrLit(c_33556801) {
      var result = [];
  for (var i = 0; i < c_33556801.length; ++i) {
    result[i] = c_33556801.charCodeAt(i);
  }
  return result;
}

function getTime_922747872() {
  var result_922747873 = ({seconds: 0, nanosecond: 0});

    var millis_922747874 = new Date().getTime();
    var seconds_922747880 = convert_922747358(2, 3, millis_922747874);
    var nanos_922747891 = convert_922747358(2, 0, modInt(millis_922747874, convert_922747358(3, 2, 1)));
    result_922747873 = nimCopy(result_922747873, initTime_922747806(seconds_922747880, chckRange(nanos_922747891, 0, 999999999)), NTI922746910);

  return result_922747873;

}

function now_922748331() {
  var result_922748332 = ({m_type: NTI922746911, nanosecond: 0, second: 0, minute: 0, hour: 0, monthdayZero: 0, monthZero: 0, year: 0, weekday: 0, yearday: 0, isDst: false, timezone: null, utcOffset: 0});

    result_922748332 = nimCopy(result_922748332, local_922748328(getTime_922747872()), NTI922746911);

  return result_922748332;

}
var i_469762051 = 0;
var f_469762052 = 0.0;
var str_469762053 = makeNimstrLit("string");
var cstr_469762054 = "cstring";
var data_469762055 = now_922748331();
```

JSã®ä¸–ç•Œã§ç´ ã®æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ã«ã¯ã€`cstring`ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### DOMæ“ä½œ
HTMLã®inputã‚¿ã‚°ã‹ã‚‰å…¥åŠ›ã—ãŸæ–‡å­—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§pã‚¿ã‚°ã«è¡¨ç¤ºã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```html:index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script defer type="module" src="app.js"></script>
  <title>Document</title>
</head>
<body>
  <input type="text" id="input">
  <p id="content"></p>
</body>
</html>
```

```nim:app.nim
import dom

proc onInput(e:Event) =
  let content = document.getElementById("content")
  content.innerText = e.target.value

let input = document.getElementById("input")
input.addEventListener("input", onInput)
```

JSãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
```js:app.js
function onInput_469762050(e_469762051) {
    var content_469762052 = document.getElementById("content");
    content_469762052.innerText = e_469762051.target.value;


}
var input_469762062 = document.getElementById("input");
input_469762062.addEventListener("input", onInput_469762050, false);
```

[domãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://nim-lang.org/docs/dom.html)ã‚’ä½¿ã†ã“ã¨ã§ã€Nimã‹ã‚‰`Event`ã€`document`ã€`getElementById`ãªã©ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### APIã‚¢ã‚¯ã‚»ã‚¹
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é–‹ç™ºã‚’ã™ã‚‹ã«ã¯APIã‚¢ã‚¯ã‚»ã‚¹ã¯æ¬ ã‹ã›ã¾ã›ã‚“ã€‚
Nimã«ã¯JSã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§APIã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ãŸã‚ã®[`jsfetch`](https://nim-lang.org/docs/jsfetch.html)ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

```nim:app.nim
import std/asyncjs
import std/jsfetch
import std/jsconsole

proc apiAccess() {.async.} =
  let url:cstring = "https://api.coindesk.com/v1/bpi/currentprice.json"
  let resp = await fetch(url)
  let json = await resp.json()
  console.log(json)

discard apiAccess()
```

JSãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
```js:app.js
async function apiAccess_469762071() {
  var result_469762073 = null;

  BeforeRet: do {
    var url_469762079 = "https://api.coindesk.com/v1/bpi/currentprice.json";
    var resp_469762087 = (await fetch(url_469762079));
    var json_469762092 = (await resp_469762087.json());
    console.log(json_469762092);
    result_469762073 = undefined;
    break BeforeRet;
  } while (false);

  return result_469762073;

}
var _ = apiAccess_469762071();
```

## ãƒ—ãƒ©ã‚°ãƒã«ã¤ã„ã¦
Nimã§ã¯JSã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é–‹ç™ºã‚’è¡Œã†æ™‚ã«ã¯ãƒ—ãƒ©ã‚°ãƒã‚’ã‚ˆãä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ—ãƒ©ã‚°ãƒã¨ã¯ä»–ã®è¨€èªã§ã‚ã‚‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªã‚‚ã®ã§ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã«å¯¾ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æŒ‡ç¤ºã‚’å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

### exportc
ã“ã‚Œã¾ã§è¦‹ã¦ããŸå‡ºåŠ›ã•ã‚ŒãŸJSãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹ã¨ã€å¤‰æ•°åã‚„é–¢æ•°åã«prefixãŒã¤ã„ã¦ã„ã¾ã—ãŸã€‚`exportc`ã‚’ä½¿ã†ã“ã¨ã§ã€prefixã‚’ä»˜ã‘ã‚‹ã®ã‚’ç¦æ­¢ã§ãã¾ã™ã€‚

```nim:app.nim
import std/jsconsole
import std/jsffi

proc hello(arg: cstring){.exportc.} =
  let arg {.exportc.} = arg
  console.log("hello " & arg)

let name {.exportc.}: cstring = "John"
hello(name)
```

```js:app.js
function hello(arg_469762052) {
    var arg = arg_469762052;
    console.log(("hello " + arg));
}
var name = "John";
hello(name);
```
### emit
emitã‚’ä½¿ã†ã¨ã€ãã®ä¸­ã§æ›¸ã„ãŸå‡¦ç†ãŒãã®ã¾ã¾å‡ºåŠ›ã•ã‚Œã‚‹JSãƒ•ã‚¡ã‚¤ãƒ«ã«å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚
JSã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é–‹ç™ºã‚’è¡Œã†æ™‚ã«ã¯ãã®ä¸­ã§ç´ ã®JSã®å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```nim:app.nim
{.emit:"""
function hello(arg){
  console.log("hello " + arg)
}
""".}
```

```js:app.js
function hello(arg){
  console.log("hello " + arg)
}
```

### importjs
JSã®é–¢æ•°ã¨Nimã®é–¢æ•°ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã€Nimã®ä¸–ç•Œã‹ã‚‰JSã®é–¢æ•°ã‚’å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚
`#`ã‚’ä½¿ã†ã¨å¼•æ•°ãŒå‰ã‹ã‚‰é †ç•ªã«ã€`@`ã‚’ä½¿ã†ã¨å¾Œã‚å…¨éƒ¨ãŒãã®ä½ç½®ã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚

```nim:app.nim
import std/jsffi

{.emit:"""
function add(a, b){
  console.log(a + b)
}
""".}

proc add(a, b:int) {.importjs:"add(#, #)".}

add(2, 3)
```

```js:app.js
function add(a, b){
  console.log(a + b)
}

add(2, 3);
```

## å®Ÿè·µçš„ãªé–‹ç™ºã‚’è¡Œã†
ã§ã¯ã“ã‚Œã¾ã§è¦‹ã¦ããŸã“ã¨ã‚’è¸ã¾ãˆã¦ã€Preactã¨ã„ã†è»½é‡ãªReacté¢¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’Nimã‹ã‚‰å‘¼ã³å‡ºã—ã¦ä½¿ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

https://preactjs.com/

ã“ã“ã§ä½¿ã†HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```html:index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script defer type="module" src="app.js"></script>
  <title>Document</title>
</head>
<body>
  <div id="app"></div>
</body>
</html>
```

### Preactã®å‡¦ç†ã‚’Nimã‹ã‚‰å‘¼ã¶

`emit`ã‚’ä½¿ã£ã¦CDNã‹ã‚‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€`importjs`ã‚’ä½¿ã£ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é–¢æ•°ã¨Nimã®é–¢æ•°ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚

```nim:lib.nim
import std/dom
import std/jsffi

# ==================== Preactã®å®šç¾© ====================

{.emit: """
import { h, render } from 'https://cdn.jsdelivr.net/npm/preact@10.11.3/+esm';
import htm from 'https://cdn.jsdelivr.net/npm/htm@3.1.1/+esm';

const html = htm.bind(h);
""".}


type Component* = JsObject

proc html*(arg:cstring):Component {.importjs:"eval('html`' + # + '`')".}
template html*(arg:string):Component = html(arg.cstring)


{.emit: """
function renderApp(component, dom){
  render(html``<${component} />``, dom)
}
""".}
proc renderApp*(component: proc():Component, dom: Element) {.importjs: "renderApp(#, #)".}

# ================== hooks ==================

{.emit:"""
import { useState, useEffect } from 'https://cdn.jsdelivr.net/npm/preact@10.11.3/hooks/+esm';
""".}

type IntStateSetter = proc(arg: int)

proc intUseState(arg: int): JsObject {.importjs: "useState(#)".}
proc useState*(arg: int): (int, IntStateSetter) =
  let state = intUseState(arg)
  let value = to(state[0], int)
  let setter = to(state[1], IntStateSetter)
  return (value, setter)


type StrStateSetter = proc(arg: cstring)

proc strUseState(arg: cstring): JsObject {.importjs: "useState(#)".}
proc useState*(arg: cstring): (cstring, StrStateSetter) =
  let state = strUseState(arg)
  let value = to(state[0], cstring)
  let setter = to(state[1], StrStateSetter)
  return (value, setter)


type States* = cstring|int|float|bool

proc useEffect*(cb: proc(), dependency: array) {.importjs: "useEffect(#, [])".}
proc useEffect*(cb: proc(), dependency: seq[States]) {.importjs: "useEffect(#, #)".}
```

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‘¼ã³å‡ºã—å´ã¯ã“ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```nim:app.nim
import std/jsffi
import std/dom
import ./lib

proc Func1():Component {.exportc.} =
  let (message {.exportc.}, setMessage) = useState("")
  let (msgLen {.exportc.}, setMsgLen) = useState(0)

  proc setMsg(e:Event) {.exportc.} =
    setMessage(e.target.value)

  useEffect(proc() =
    setMsgLen(message.len)
  , @[message])

  return html("""
    <input type="text" oninput=${setMsg} />
    <p>${message}</p>
    <p>message length...${msgLen}</p>
  """)

renderApp(Func1, document.getElementById("app"))
```

ã“ã®ã‚ˆã†ã«å‹•ãã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/2a2a229dfea6-20230213.jpg)

### JavaScriptã®é™çš„å‹ä»˜ã‘ã¨ã—ã¦ã®Nim
```nim
let (message {.exportc.}, setMessage) = useState("")
```

ã“ã“ã§ã®`setMessage`ã¯cstringå‹ã—ã‹å¼•æ•°ã¨ã—ã¦å—ã‘ä»˜ã‘ãªã„é–¢æ•°ã§ã‚ã‚‹`StrStateSetter`ã§ã™ã€‚
`lib.nim`ã§ã“ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

```nim
type StrStateSetter = proc(arg: cstring)

proc strUseState(arg: cstring): JsObject {.importjs: "useState(#)".}
proc useState*(arg: cstring): (cstring, StrStateSetter) =
  let state = strUseState(arg)
  let value = to(state[0], cstring)
  let setter = to(state[1], StrStateSetter)
  return (value, setter)
```

ã‚‚ã—ã“ã“ã§intå‹ã‚’å…¥ã‚Œã‚ˆã†ã¨ã™ã‚‹ã¨ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹

```nim
proc setMsg(e:Event) {.exportc.} =
  # setMessage(e.target.value)
  setMessage(1)
```

ã‚‚ã¡ã‚ã‚“ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```sh
/projects/nimjs/app.nim(11, 15) Error: type mismatch: got <int literal(1)>
but expected one of:
StrStateSetter = proc (arg: cstring){.closure.}
```
